<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
  body {
    background: linear-gradient(135deg, #f4f8f6, #eef6f1);
  }

  /* ---------- Grid ---------- */
  .category-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
  }

  @media (max-width: 768px) {
    .category-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 480px) {
    .category-grid {
      grid-template-columns: repeat(1, 1fr);
    }
  }

  /* ---------- Category Card ---------- */
  .category-box {
    border-radius: 14px;
    padding: 14px 10px;
    background: #ffffff;
    text-align: center;
    cursor: pointer;
    user-select: none;
    transition: all 0.25s ease;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
  }

  .category-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
  }

  .category-box.active {
    background: linear-gradient(135deg, #d1e7dd, #e9f7ef);
    border-color: #198754;
    color: #0f5132;
    font-weight: 700;
  }

  .category-title {
    font-size: 1rem;
    font-weight: 600;
  }

  .category-count {
    display: inline-block;
    margin-top: 6px;
    padding: 2px 10px;
    font-size: 0.8rem;
    border-radius: 999px;
    background: #e9ecef;
    color: #495057;
    font-weight: 600;
  }

  .category-box.active .category-count {
    background: #198754;
    color: #ffffff;
  }

  /* ---------- Select All ---------- */
  .select-all-box {
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, #fff3cd, #fff8e1);
    border: 2px dashed #ffca2c;
    border-radius: 12px;
    padding: 12px 14px;
    cursor: pointer;
    font-weight: 600;
  }

  /* ---------- Form Card ---------- */
  .quiz-card {
    background: #ffffff;
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
  }

  /* ---------- Buttons ---------- */
  .btn-success {
    background: linear-gradient(135deg, #198754, #2fbf71);
    border: none;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #157347, #26a963);
  }

  .btn-outline-primary {
    border-radius: 14px;
    font-weight: 600;
  }

  .hidden-checkbox {
    display: none;
  }
</style>

<div class="container mt-5 mb-5" style="max-width: 920px;">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-success">üßò‚Äç‚ôÄÔ∏è ‡§Ø‡•ã‡§ó ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•á‡§Ç</h2>
    <p class="text-muted fs-6">
      ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å ‡§ö‡•Å‡§®‡•á‡§Ç ‚Ä¢ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç ‚Ä¢ ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•ã ‡§ó‡§π‡§∞‡§æ‡§è‡§Å
    </p>
  </div>

  <form
    action="/quiz/start"
    method="POST"
    class="quiz-card"
    id="quizStartForm"
    novalidate
  >

    <input type="hidden" name="actionType" id="actionType" value="start">

    <!-- Question Count -->
    <div class="mb-4">
      <label class="form-label fw-semibold fs-5">
        ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ (5‚Äì20)
      </label>
      <input
        type="number"
        inputmode="numeric"
        name="numQuestions"
        class="form-control form-control-lg text-center"
        min="5"
        max="20"
        value="5"
        required
      >
    </div>

    <!-- Categories -->
    <div class="mb-4">
      <label class="form-label fw-semibold fs-5">
        ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å ‡§ö‡•Å‡§®‡•á‡§Ç
      </label>

      <div class="select-all-box mb-3">
        <input type="checkbox" class="form-check-input" id="selectAll">
        <label for="selectAll">‚úîÔ∏è ‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å ‡§ö‡•Å‡§®‡•á‡§Ç / ‡§π‡§ü‡§æ‡§è‡§Å</label>
      </div>

      <div class="category-grid">
        <% categories.forEach(c => { %>

          <div class="category-box" data-category="<%= c._id %>">
            <div class="category-title">
              <%= c._id %>
            </div>
            <span class="category-count">
              <%= c.count %> ‡§™‡•ç‡§∞‡§∂‡•ç‡§®
            </span>
          </div>

          <input
            type="checkbox"
            class="hidden-checkbox category-checkbox"
            name="categories"
            value="<%= c._id %>"
            id="cb_<%= c._id %>"
          >

        <% }) %>
      </div>
    </div>

    <!-- Buttons -->
    <div class="d-grid mt-4">
      <button
        type="submit"
        class="btn btn-success btn-lg py-3"
        onclick="document.getElementById('actionType').value='start'"
      >
        üöÄ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•á‡§Ç
      </button>
    </div>

    <div class="d-grid mt-3">
      <button
        type="submit"
        formaction="/quiz/print"
        formmethod="POST"
        class="btn btn-outline-primary btn-lg py-3"
        onclick="document.getElementById('actionType').value='print'"
      >
        üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º (PDF)
      </button>
    </div>

  </form>
</div>

<script>
  const printBtn = document.querySelector('button[formaction="/quiz/print"]');

  printBtn.addEventListener("click", function (e) {
    e.preventDefault();

    const form = printBtn.closest("form");
    const selected = document.querySelectorAll('.category-checkbox:checked');

    if (selected.length === 0) {
      bootstrap.Modal.getOrCreateInstance(
        document.getElementById('categoryModal')
      ).show();
      return;
    }

    const numQ = document.querySelector('input[name="numQuestions"]').value;
    if (numQ < 5) {
      bootstrap.Modal.getOrCreateInstance(
        document.getElementById('questionModal')
      ).show();
      return;
    }

    form.action = printBtn.getAttribute("formaction");
    form.method = "POST";
    form.submit();
  });

  document.querySelectorAll('.category-box').forEach(box => {
    box.addEventListener('click', () => {
      const val = box.dataset.category;
      const checkbox = document.querySelector('#cb_' + CSS.escape(val));
      checkbox.checked = !checkbox.checked;
      box.classList.toggle('active');
    });
  });

  document.getElementById('selectAll').addEventListener('change', function () {
    document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = this.checked);
    document.querySelectorAll('.category-box').forEach(box => {
      box.classList.toggle('active', this.checked);
    });
  });

  document.getElementById('quizStartForm').addEventListener('submit', function (e) {
    if (!document.querySelector('.category-checkbox:checked')) {
      e.preventDefault();
      bootstrap.Modal.getOrCreateInstance(
        document.getElementById('categoryModal')
      ).show();
    }
  });
</script>

<%- include('../partials/footer') %>
