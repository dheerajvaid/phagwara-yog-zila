<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
  .category-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  @media (max-width: 768px) {
    .category-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .category-box {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    background-color: #f8f9fa;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease-in-out;
  }

  .category-box.active {
    background-color: #d1e7dd;
    border-color: #0f5132;
    color: #0f5132;
    font-weight: bold;
  }

  .select-all-box {
    background-color: #fff3cd;
    border: 2px solid #ffeeba;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
  }

  .hidden-checkbox {
    display: none;
  }
</style>

<div class="container mt-5 mb-5" style="max-width: 900px;">
  <div class="text-center mb-4">
    <h2 class="fw-bold">üßò‚Äç‚ôÄÔ∏è ‡§Ø‡•ã‡§ó ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•á‡§Ç</h2>
    <p class="text-muted">‡§Ö‡§™‡§®‡•Ä ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</p>
  </div>

  <form action="/quiz/start" method="POST" class="p-4 border rounded bg-light shadow-sm" id="quizStartForm">

    <!-- Hidden field to detect button clicked -->
    <input type="hidden" name="actionType" id="actionType" value="start">

    <div class="mb-4">
      <label for="numQuestions" class="form-label fw-semibold fs-5">‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ (5 ‡§∏‡•á 20):</label>
      <input type="number" name="numQuestions" class="form-control form-control-lg" min="5" max="20" value="5" required>
    </div>

    <div class="mb-4">
      <label class="form-label fw-semibold fs-5">‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å ‡§ö‡•Å‡§®‡•á‡§Ç:</label>

      <div class="select-all-box mb-3" id="selectAllBox">
        <input type="checkbox" class="form-check-input me-2" id="selectAll">
        <label class="form-check-label fw-bold" for="selectAll">‚úîÔ∏è ‡§∏‡§≠‡•Ä ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç / ‡§π‡§ü‡§æ‡§è‡§Å</label>
      </div>

      <div class="category-grid">
        <% categories.forEach(c => { %>
          <div class="category-box" data-category="<%= c %>"><%= c %></div>
          <input type="checkbox" class="hidden-checkbox category-checkbox" name="categories" value="<%= c %>" id="cb_<%= c %>">
        <% }) %>
      </div>
    </div>

    <div class="d-grid mt-4">
      <button type="submit" class="btn btn-success btn-lg"
              onclick="document.getElementById('actionType').value='start'">
        üöÄ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•á‡§Ç
      </button>
    </div>

    <div class="d-grid mt-3">
      <button type="submit"
              formaction="/quiz/print"
              formmethod="POST"
              class="btn btn-outline-primary btn-lg"
              onclick="document.getElementById('actionType').value='print'">
        üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º (PDF)
      </button>
    </div>

  </form>
</div>

<!-- Category Validation Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="categoryModalLabel">‚ö†Ô∏è ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">‡§†‡•Ä‡§ï ‡§π‡•à</button>
      </div>
    </div>
  </div>
</div>

<!-- Minimum Questions Modal -->
<div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="questionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="questionModalLabel">‚ö†Ô∏è ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ <strong>5 ‡§™‡•ç‡§∞‡§∂‡•ç‡§®</strong> ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡§Ç‡•§
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">‡§†‡•Ä‡§ï ‡§π‡•à</button>
      </div>
    </div>
  </div>
</div>

<script>

  const printBtn = document.querySelector('button[formaction="/quiz/print"]');

  printBtn.addEventListener("click", function (e) {
    e.preventDefault();   // stop default submit

    const form = printBtn.closest("form");

    const selected = document.querySelectorAll('.category-checkbox:checked');
    if (selected.length === 0) {
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('categoryModal'));
      modal.show();
      return;
    }

    // üî• VALIDATE NUMBER OF QUESTIONS (MIN 5)
    const numQ = document.querySelector('input[name="numQuestions"]').value;
    if (numQ < 5) {
      const qModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('questionModal'));
      qModal.show();
      return;
    }

    form.action = printBtn.getAttribute("formaction");
    form.method = printBtn.getAttribute("formmethod") || "POST";

    const spinner = document.getElementById("loadingSpinner");
    if (spinner) spinner.style.display = "block";

    setTimeout(() => {
      if (spinner) spinner.style.display = "none";
    }, 2000);

    form.submit();
  });

  // Toggle selection
  document.querySelectorAll('.category-box').forEach(box => {
    box.addEventListener('click', () => {
      const val = box.dataset.category;
      const checkbox = document.querySelector('#cb_' + CSS.escape(val));
      checkbox.checked = !checkbox.checked;
      box.classList.toggle('active');
    });
  });

  // Select All
  document.getElementById('selectAll').addEventListener('change', function () {
    const allBoxes = document.querySelectorAll('.category-box');
    const allChecks = document.querySelectorAll('.category-checkbox');

    allChecks.forEach(cb => cb.checked = this.checked);
    allBoxes.forEach(box => {
      if (this.checked) box.classList.add('active');
      else box.classList.remove('active');
    });
  });

  // Start Quiz Validation
  document.getElementById('quizStartForm').addEventListener('submit', function (e) {
    const selected = document.querySelectorAll('.category-checkbox:checked');

    if (selected.length === 0) {
      e.preventDefault();
      e.stopImmediatePropagation();
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('categoryModal'));
      modal.show();
    }
  });

</script>

<%- include('../partials/footer') %>
