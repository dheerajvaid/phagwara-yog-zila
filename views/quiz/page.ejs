<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
  /* ЁЯМЯ Modern Quiz Container */
  .quiz-box {
    background: #ffffff;
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0px 4px 16px rgba(0,0,0,0.08);
    border-left: 6px solid #e53935;
  }

  /* ЁЯМЯ Question Section Box */
  .question-container {
    background: linear-gradient(135deg, #fffafa, #fff0f0);
    border: 1px solid #ffdddd;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0px 3px 12px rgba(0,0,0,0.05);
    margin-bottom: 16px;
  }

  /* ЁЯМЯ Question Styling */
  .question-text {
    font-size: 1.2rem;
    font-weight: 700;
    color: #c62828;
    line-height: 1.7rem;
    margin-bottom: 12px;
  }

  /* тЬи Contributor Badge */
  .contributor-box {
    background: #e3f2fd;
    padding: 8px 14px;
    border-radius: 8px;
    border-left: 5px solid #1565c0;
    display: inline-block;
    font-size: 0.9rem;
    color: #0d47a1;
  }

  .contributor-name {
    font-weight: 700;
    color: #0d47a1;
  }

  /* ЁЯФШ Modern Option Box */
  .option-card {
    display: flex;
    align-items: center;
    padding: 12px 14px;
    margin-bottom: 12px;
    border: 2px solid #d6d6d6;
    border-radius: 10px;
    transition: 0.25s;
    cursor: pointer;
    background: #ffffff;
  }

  /* Hover Effect */
  .option-card:hover {
    background: #f7faff;
    border-color: #1565c0;
  }

  /* Hide old input circle visually */
  .form-check-input {
    width: 18px;
    height: 18px;
    margin-right: 12px;
    border: 2px solid #333;
  }

  /* When selected */
  .form-check-input:checked {
    background-color: #1565c0;
    border-color: #1565c0;
  }

  /* Smooth progress bar */
  .progress-bar {
    transition: width 0.4s ease-in-out;
    font-weight: 600;
  }
</style>


<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5>ЁЯзШ рдкреНрд░рд╢реНрди <%= current + 1 %> / <%= total %></h5>
    <div>
      <button class="btn btn-outline-danger btn-sm me-2" data-bs-toggle="modal" data-bs-target="#exitQuizModal">тЫФя╕П Exit Quiz</button>
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#restartQuizModal">ЁЯФД Restart</button>
    </div>
  </div>

  <div class="progress mb-3 mt-2">
    <div class="progress-bar" style="width: <%= ((current + 1) / total) * 100 %>%;"><%= current + 1 %> / <%= total %></div>
  </div>

  <form id="answerForm" action="/quiz/<%= sessionId %>/answer?idx=<%= current %>" method="POST">
    <div class="mb-4">

      <!-- ЁЯМЯ NEW BEAUTIFUL QUESTION BOX -->
      <div class="question-container">
        <div class="question-text"><%= question.text %></div>

        <% if (question.contributedBy?.name) { %>
          <div class="contributor-box mt-2">
            ЁЯУЭ Contributed by:
            <span class="contributor-name"><%= question.contributedBy.name %></span>
            <% if (question.contributedBy.designation) { %>
              (<%= question.contributedBy.designation %>)
            <% } %>
          </div>
        <% } %>
      </div>
      <!-- END QUESTION BOX -->

      <% question.options.forEach((opt, i) => { %>
        <label for="opt<%= i %>" class="option-card">
          <input class="form-check-input"
                type="<%= question.correctAnswers.length > 1 ? 'checkbox' : 'radio' %>"
                name="answer"
                value="<%= i %>"
                id="opt<%= i %>"
                <%= (Array.isArray(selectedAnswer) && selectedAnswer.includes(i)) || selectedAnswer == i ? 'checked' : '' %> >
          
          <span><%= opt %></span>
        </label>
      <% }) %>

    </div>

    <div class="d-flex justify-content-between">
      <% if (current > 0) { %>
        <a href="/quiz/<%= sessionId %>?idx=<%= current - 1 %>" class="btn btn-secondary">тмЕя╕П рдкрд┐рдЫрд▓рд╛</a>
      <% } else { %>
        <span></span>
      <% } %>

      <% if (current < total - 1) { %>
        <button type="submit" class="btn btn-primary">рдЕрдЧрд▓рд╛ тЮбя╕П</button>
      <% } else { %>
        <!-- Final submit button triggers modal -->
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#submitModal">ЁЯУи рдЙрддреНрддрд░ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
      <% } %>
    </div>
  </form>
</div>

<!-- ЁЯФФ Final Submit Modal -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="submitModalLabel">рдХреНрдпрд╛ рдЖрдк рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рд╣реИрдВ?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="рдмрдВрдж рдХрд░реЗрдВ"></button>
      </div>
      <div class="modal-body">
        рдЖрдк рдЕрдкрдирд╛ рдХреНрд╡рд┐рдЬрд╝ рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред рдХреНрдпрд╛ рдЖрдк рдЖрдЧреЗ рдмрдврд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ рдирд╣реАрдВ</button>

        <!-- тЬЕ This form will save final answer and redirect to /submit -->
        <form id="finalSubmitForm" action="/quiz/<%= sessionId %>/answer?idx=<%= current %>" method="POST">
          <input type="hidden" name="finalAnswer" id="finalAnswerInput">
          <button type="submit" class="btn btn-success">тЬЕ рд╣рд╛рдБ, рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ЁЯФФ Exit Modal -->
<div class="modal fade" id="exitQuizModal" tabindex="-1" aria-labelledby="exitQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="exitQuizModalLabel">тЫФя╕П рдХреНрд╡рд┐рдЬрд╝ рдЫреЛрдбрд╝реЗрдВ?</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="рдмрдВрдж рдХрд░реЗрдВ"></button>
      </div>
      <div class="modal-body">
        рдпрджрд┐ рдЖрдк рдЕрднреА рдмрд╛рд╣рд░ рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХрд╛ рдЙрддреНрддрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд░рд╣реЗрдЧрд╛ред рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ рдирд╣реАрдВ</button>
        <a href="/" class="btn btn-danger">ЁЯЪк рд╣рд╛рдБ, рдмрд╛рд╣рд░ рдЬрд╛рдПрдБ</a>
      </div>
    </div>
  </div>
</div>

<!-- ЁЯФБ Restart Modal -->
<div class="modal fade" id="restartQuizModal" tabindex="-1" aria-labelledby="restartQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="restartQuizModalLabel">ЁЯФД рдХреНрд╡рд┐рдЬрд╝ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ?</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="рдмрдВрдж рдХрд░реЗрдВ"></button>
      </div>
      <div class="modal-body">
        рдЗрд╕рд╕реЗ рдЖрдкрдХрд╛ рд╡рд░реНрддрдорд╛рди рдкреНрд░рдЧрддрд┐ рдорд┐рдЯ рдЬрд╛рдПрдЧреА рдФрд░ рдЖрдк рдореБрдЦреНрдп рдкреГрд╖реНрда рдкрд░ рд▓реМрдЯ рдЬрд╛рдПрдВрдЧреЗред рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рджреЛрдмрд╛рд░рд╛ рд╢реБрд░реВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ рдирд╣реАрдВ</button>
        <a href="/quiz/start" class="btn btn-primary">ЁЯФБ рд╣рд╛рдБ, рд╢реБрд░реВ рдХрд░реЗрдВ</a>
      </div>
    </div>
  </div>
</div>

<!-- тЬЕ JS to collect final selected answers into hidden field -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const finalSubmitBtn = document.querySelector('[data-bs-target="#submitModal"]');
    const finalAnswerInput = document.getElementById("finalAnswerInput");

    if (!finalSubmitBtn || !finalAnswerInput) return;

    finalSubmitBtn.addEventListener("click", function () {
      const selected = document.querySelectorAll('input[name="answer"]:checked');

      if (selected.length === 0) {
        finalAnswerInput.value = '';
      } else if (selected.length === 1) {
        finalAnswerInput.value = selected[0].value;
      } else {
        finalAnswerInput.value = Array.from(selected).map(i => i.value).join(',');
      }
    });
  });
</script>

<%- include('../partials/footer') %>
