<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5>ЁЯзШ рдкреНрд░рд╢реНрди <%= current + 1 %> / <%= total %></h5>
    <div>
      <button class="btn btn-outline-danger btn-sm me-2" data-bs-toggle="modal" data-bs-target="#exitQuizModal">тЫФя╕П Exit Quiz</button>
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#restartQuizModal">ЁЯФД Restart</button>
    </div>
  </div>

  <div class="progress mb-3 mt-2">
    <div class="progress-bar" style="width: <%= ((current + 1) / total) * 100 %>%;"><%= current + 1 %> / <%= total %></div>
  </div>

  <form id="answerForm" action="/quiz/<%= sessionId %>/answer?idx=<%= current %>" method="POST">
    <div class="mb-4">
      <h5 class="text-danger fw-bold"><%= question.text %></h5>

      <% if (question.contributedBy?.name) { %>
        <p class="text-primary fst-italic small mt-2">
          <span class="text-dark">ЁЯУЭ Contributed by: </span><span class="text-danger"><%= question.contributedBy.name %></span>
          <% if (question.contributedBy.designation) { %>
            (<%= question.contributedBy.designation %>)
          <% } %>
        </p>
      <% } %>

      <% question.options.forEach((opt, i) => { %>
        <div class="form-check">
          <input class="form-check-input"
                 type="<%= question.correctAnswers.length > 1 ? 'checkbox' : 'radio' %>"
                 name="answer"
                 value="<%= i %>"
                 id="opt<%= i %>"
                 <%= (Array.isArray(selectedAnswer) && selectedAnswer.includes(i)) || selectedAnswer == i ? 'checked' : '' %>>
          <label class="form-check-label" for="opt<%= i %>"><%= opt %></label>
        </div>
      <% }) %>
    </div>

    <div class="d-flex justify-content-between">
      <% if (current > 0) { %>
        <a href="/quiz/<%= sessionId %>?idx=<%= current - 1 %>" class="btn btn-secondary">тмЕя╕П рдкрд┐рдЫрд▓рд╛</a>
      <% } else { %>
        <span></span>
      <% } %>

      <% if (current < total - 1) { %>
        <button type="submit" class="btn btn-primary">рдЕрдЧрд▓рд╛ тЮбя╕П</button>
      <% } else { %>
        <!-- Final submit button triggers modal -->
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#submitModal">ЁЯУи рдЙрддреНрддрд░ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
      <% } %>
    </div>
  </form>
</div>

<!-- ЁЯФФ Final Submit Modal -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="submitModalLabel">рдХреНрдпрд╛ рдЖрдк рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рд╣реИрдВ?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="рдмрдВрдж рдХрд░реЗрдВ"></button>
      </div>
      <div class="modal-body">
        рдЖрдк рдЕрдкрдирд╛ рдХреНрд╡рд┐рдЬрд╝ рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред рдХреНрдпрд╛ рдЖрдк рдЖрдЧреЗ рдмрдврд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ рдирд╣реАрдВ</button>

        <!-- тЬЕ This form will save final answer and redirect to /submit -->
        <form id="finalSubmitForm" action="/quiz/<%= sessionId %>/answer?idx=<%= current %>" method="POST">
          <input type="hidden" name="finalAnswer" id="finalAnswerInput">
          <button type="submit" class="btn btn-success">тЬЕ рд╣рд╛рдБ, рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ЁЯФФ Exit Modal -->
<div class="modal fade" id="exitQuizModal" tabindex="-1" aria-labelledby="exitQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="exitQuizModalLabel">тЫФя╕П рдХреНрд╡рд┐рдЬрд╝ рдЫреЛрдбрд╝реЗрдВ?</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="рдмрдВрдж рдХрд░реЗрдВ"></button>
      </div>
      <div class="modal-body">
        рдпрджрд┐ рдЖрдк рдЕрднреА рдмрд╛рд╣рд░ рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХрд╛ рдЙрддреНрддрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд░рд╣реЗрдЧрд╛ред рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ рдирд╣реАрдВ</button>
        <a href="/" class="btn btn-danger">ЁЯЪк рд╣рд╛рдБ, рдмрд╛рд╣рд░ рдЬрд╛рдПрдБ</a>
      </div>
    </div>
  </div>
</div>

<!-- ЁЯФБ Restart Modal -->
<div class="modal fade" id="restartQuizModal" tabindex="-1" aria-labelledby="restartQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="restartQuizModalLabel">ЁЯФД рдХреНрд╡рд┐рдЬрд╝ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ?</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="рдмрдВрдж рдХрд░реЗрдВ"></button>
      </div>
      <div class="modal-body">
        рдЗрд╕рд╕реЗ рдЖрдкрдХрд╛ рд╡рд░реНрддрдорд╛рди рдкреНрд░рдЧрддрд┐ рдорд┐рдЯ рдЬрд╛рдПрдЧреА рдФрд░ рдЖрдк рдореБрдЦреНрдп рдкреГрд╖реНрда рдкрд░ рд▓реМрдЯ рдЬрд╛рдПрдВрдЧреЗред рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рджреЛрдмрд╛рд░рд╛ рд╢реБрд░реВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ рдирд╣реАрдВ</button>
        <a href="/quiz/start" class="btn btn-primary">ЁЯФБ рд╣рд╛рдБ, рд╢реБрд░реВ рдХрд░реЗрдВ</a>
      </div>
    </div>
  </div>
</div>

<!-- тЬЕ JS to collect final selected answers into hidden field -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const finalSubmitBtn = document.querySelector('[data-bs-target="#submitModal"]');
    const finalAnswerInput = document.getElementById("finalAnswerInput");

    if (!finalSubmitBtn || !finalAnswerInput) return;

    finalSubmitBtn.addEventListener("click", function () {
      const selected = document.querySelectorAll('input[name="answer"]:checked');

      if (selected.length === 0) {
        finalAnswerInput.value = '';
      } else if (selected.length === 1) {
        finalAnswerInput.value = selected[0].value;
      } else {
        finalAnswerInput.value = Array.from(selected).map(i => i.value).join(',');
      }
    });
  });
</script>

<%- include('../partials/footer') %>
