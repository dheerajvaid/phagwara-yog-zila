<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<section class="container mt-4">
  <h4 class="mb-4 fw-bold text-primary">üñäÔ∏è Edit Saadhak</h4>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <form action="/saadhak/edit/<%= saadhak._id %>" method="POST" class="row g-3" onsubmit="cleanMobileNumberById('mobile')">
    
    <!-- Role -->
    <div class="col-md-4">
      <label class="form-label">Select Role *</label>
      <select name="role" class="form-select" id="roleSelect" required>
        <option value="">-- Select --</option>
        <% allowedRoles.forEach(r => { %>
          <option value="<%= r %>" <%= saadhak.role.includes(r) ? 'selected' : '' %>><%= r %></option>
        <% }) %>
      </select>
    </div>

    <!-- Name -->
    <div class="col-md-4">
      <label class="form-label">Full Name *</label>
      <input type="text" name="name" class="form-control" required value="<%= saadhak.name %>">
    </div>

    <!-- Mobile -->
    <div class="col-md-4">
      <label class="form-label">Mobile *</label>
      <input type="text" name="mobile" id="mobile" class="form-control" required value="<%= saadhak.mobile %>">
    </div>

    <!-- Email -->
<div class="col-md-4">
  <label class="form-label">Email</label>
  <input 
    type="email" 
    name="email" 
    class="form-control" 
    maxlength="60"
    placeholder="example@email.com"
    value="<%= saadhak?.email || '' %>"
    pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$"
    title="Please enter a valid email address">
</div>

    
    <% const selectedPrant = saadhak?.prant || user.prant; %>
    <% const selectedZila = saadhak?.zila || user.zila; %>
    <% const selectedKsheterId = saadhak?.ksheter || user.ksheter; %>
    <% const selectedKenderId = saadhak?.kender || user.kender; %>

    <!-- Prant -->
    <div class="col-md-4 prant-field d-none">
      <label class="form-label">Prant</label>
      <select name="prant" id="prantSelect" class="form-select" <%= user.prant ? 'disabled' : '' %>>
        <option value="">-- Select Prant --</option>
        <% prants.forEach(p => { %>
          <option value="<%= p._id %>" <%= (selectedPrant == p._id.toString()) ? 'selected' : '' %>><%= p.name %></option>
        <% }) %>
      </select>
      <% if (user.prant) { %>
        <input type="hidden" name="prant" value="<%= user.prant %>">
      <% } %>
    </div>

    <!-- Zila -->
    <div class="col-md-4 zila-field d-none">
      <label class="form-label">Zila</label>
      <select name="zila" id="zilaSelect" class="form-select" <%= user.zila ? 'disabled' : '' %>>
        <option value="">-- Select Zila --</option>
        <% zilas.forEach(z => { %>
          <% if (z.prant.toString() === selectedPrant?.toString()) { %>
            <option value="<%= z._id %>" <%= (selectedZila == z._id.toString()) ? 'selected' : '' %>><%= z.name %></option>
          <% } %>
        <% }) %>
      </select>
      <% if (user.zila) { %>
        <input type="hidden" name="zila" value="<%= user.zila %>">
      <% } %>
    </div>

    <!-- Ksheter -->
    <div class="col-md-4 ksheter-field d-none">
      <label class="form-label">Ksheter</label>
      <select name="ksheter" id="ksheterSelect" class="form-select" <%= user.ksheter ? 'disabled' : '' %>>
        <option value="">-- Select Ksheter --</option>
        <% ksheters.forEach(k => { %>
          <% if (k.zila.toString() === selectedZila?.toString()) { %>
            <option value="<%= k._id %>" <%= (selectedKsheterId == k._id.toString()) ? 'selected' : '' %>><%= k.name %></option>
          <% } %>
        <% }) %>
      </select>
      <% if (user.ksheter) { %>
        <input type="hidden" name="ksheter" value="<%= user.ksheter %>">
      <% } %>
    </div>

    <!-- Kender -->
    <div class="col-md-4 kender-field d-none">
      <label class="form-label">Kender</label>
      <select name="kender" id="kenderSelect" class="form-select" <%= user.kender ? 'disabled' : '' %>>
        <option value="">-- Select Kender --</option>
        <% kenders.forEach(k => { %>
          <% if (k.ksheter.toString() === selectedKsheterId?.toString()) { %>
            <option value="<%= k._id %>" <%= (selectedKenderId == k._id.toString()) ? 'selected' : '' %>><%= k.name %></option>
          <% } %>
        <% }) %>
      </select>
      <% if (user.kender) { %>
        <input type="hidden" name="kender" value="<%= user.kender %>">
      <% } %>
    </div>

     <!-- Date of Joining -->
    <div class="col-md-4">
      <label class="form-label">Date of Joining</label>
      <div class="d-flex gap-2">
        <select name="doj_day" class="form-select">
          <option value="">Day</option>
          <% for(let d=1; d<=31; d++) { %>
            <option value="<%= d %>" <%= saadhak?.doj_day == d ? 'selected' : '' %>><%= d %></option>
          <% } %>
        </select>
        <select name="doj_month" class="form-select">
          <option value="">Month</option>
          <% for(let m=1; m<=12; m++) { %>
            <option value="<%= m %>" <%= saadhak?.doj_month == m ? 'selected' : '' %>><%= months[m-1] %></option>
          <% } %>
        </select>
        <select name="doj_year" class="form-select">
          <option value="">Year</option>
          <% for(let y=currentYear; y>=1900; y--) { %>
            <option value="<%= y %>" <%= saadhak?.doj_year == y ? 'selected' : '' %>><%= y %></option>
          <% } %>
        </select>
      </div>
    </div>

    <!-- DOB -->
    <div class="col-md-4">
      <label class="form-label">DOB</label>
      <div class="d-flex gap-2">
        <select name="dob_day" class="form-select">
          <option value="">Day</option>
          <% for(let d=1; d<=31; d++) { %>
            <option value="<%= d %>" <%= saadhak?.dob_day == d ? 'selected' : '' %>><%= d %></option>
          <% } %>
        </select>
        <select name="dob_month" class="form-select">
          <option value="">Month</option>
          <% for(let m=1; m<=12; m++) { %>
            <option value="<%= m %>" <%= saadhak?.dob_month == m ? 'selected' : '' %>><%= months[m-1] %></option>
          <% } %>
        </select>
        <select name="dob_year" class="form-select">
          <option value="">Year</option>
          <% for(let y=currentYear; y>=1900; y--) { %>
            <option value="<%= y %>" <%= saadhak?.dob_year == y ? 'selected' : '' %>><%= y %></option>
          <% } %>
        </select>
      </div>
    </div>

    <!-- Gender -->
    <div class="col-md-4">
      <label class="form-label">Gender</label>
      <select name="gender" class="form-select">
        <option value="">--</option>
        <option value="Male" <%= saadhak.gender === 'Male' ? 'selected' : '' %>>Male</option>
        <option value="Female" <%= saadhak.gender === 'Female' ? 'selected' : '' %>>Female</option>
      </select>
    </div>

    <!-- Marital Status -->
    <div class="col-md-4">
      <label class="form-label">Marital Status</label>
      <select name="maritalStatus" class="form-select">
        <option value="">--</option>
        <option value="Married" <%= saadhak.maritalStatus === 'Married' ? 'selected' : '' %>>Married</option>
        <option value="Unmarried" <%= saadhak.maritalStatus === 'Unmarried' ? 'selected' : '' %>>Unmarried</option>
      </select>
    </div>

    <!-- Marriage Date -->
    <div class="col-md-4">
      <label class="form-label">Marriage Date</label>
      <div class="d-flex gap-2">
        <select name="dom_day" class="form-select">
          <option value="">Day</option>
          <% for(let d=1; d<=31; d++) { %>
            <option value="<%= d %>" <%= saadhak?.dom_day == d ? 'selected' : '' %>><%= d %></option>
          <% } %>
        </select>
        <select name="dom_month" class="form-select">
          <option value="">Month</option>
          <% for(let m=1; m<=12; m++) { %>
            <option value="<%= m %>" <%= saadhak?.dom_month == m ? 'selected' : '' %>><%= months[m-1] %></option>
          <% } %>
        </select>
        <select name="dom_year" class="form-select">
          <option value="">Year</option>
          <% for(let y=currentYear; y>=1900; y--) { %>
            <option value="<%= y %>" <%= saadhak?.dom_year == y ? 'selected' : '' %>><%= y %></option>
          <% } %>
        </select>
      </div>
    </div>


    <!-- Address -->
    <div class="col-md-6">
      <label class="form-label">Address</label>
      <input type="text" name="address" class="form-control" value="<%= saadhak.address || '' %>">
    </div>

    <!-- Living Area -->
    <div class="col-md-6" hidden>
      <label class="form-label">Living Area</label>
      <input type="text" name="livingArea" class="form-control" value="<%= saadhak.livingArea || '' %>">
    </div>

    <div class="col-12 text-end">
      <button class="btn btn-primary">üíæ Save Changes</button>
    </div>
  </form>
</section>

<!-- JS Data -->
<script>
  const allZilas = <%- JSON.stringify(zilas.map(z => ({ _id: z._id.toString(), name: z.name, prant: z.prant?.toString() }))) %>;
  const allKsheters = <%- JSON.stringify(ksheters.map(k => ({ _id: k._id.toString(), name: k.name, zila: k.zila.toString() }))) %>;
  const allKenders = <%- JSON.stringify(kenders.map(k => ({ _id: k._id.toString(), name: k.name, ksheter: k.ksheter.toString() }))) %>;
  const roleConfig = <%- JSON.stringify(roleConfig) %>;
</script>

<!-- JS Logic -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const roleSelect = document.getElementById('roleSelect');
    const prantField = document.querySelector('.prant-field');
    const zilaField = document.querySelector('.zila-field');
    const ksheterField = document.querySelector('.ksheter-field');
    const kenderField = document.querySelector('.kender-field');

    const prantSelect = document.getElementById('prantSelect');
    const zilaSelect = document.getElementById('zilaSelect');
    const ksheterSelect = document.getElementById('ksheterSelect');
    const kenderSelect = document.getElementById('kenderSelect');

    const roleHierarchyMap = {
      adminRoles: [],
      prantRoles: ['prant'],
      zilaRoles: ['prant', 'zila'],
      ksheterRoles: ['prant', 'zila', 'ksheter'],
      kenderRoles: ['prant', 'zila', 'ksheter', 'kender'],
      kenderTeamRoles: ['prant', 'zila', 'ksheter', 'kender'],
      saadhakRoles: ['prant', 'zila', 'ksheter', 'kender'],
    };

    function getFieldVisibilityForRole(role) {
      for (const [group, roles] of Object.entries(roleConfig)) {
        if (roles.includes(role)) {
          return roleHierarchyMap[group] || [];
        }
      }
      return [];
    }

    function toggleFields(role) {
      const visibleFields = getFieldVisibilityForRole(role);
      const allFields = { prant: prantField, zila: zilaField, ksheter: ksheterField, kender: kenderField };

      for (const [field, el] of Object.entries(allFields)) {
        el.classList.toggle('d-none', !visibleFields.includes(field));
      }
    }

    prantSelect?.addEventListener('change', function () {
      const prantId = this.value;
      const filteredZilas = allZilas.filter(z => z.prant === prantId);
      zilaSelect.innerHTML = '<option value="">-- Select Zila --</option>';
      filteredZilas.forEach(z => {
        zilaSelect.innerHTML += `<option value="${z._id}">${z.name}</option>`;
      });
      ksheterSelect.innerHTML = '<option value="">-- Select Ksheter --</option>';
      kenderSelect.innerHTML = '<option value="">-- Select Kender --</option>';
    });

    zilaSelect?.addEventListener('change', function () {
      const zilaId = this.value;
      const filteredKsheters = allKsheters.filter(k => k.zila === zilaId);
      ksheterSelect.innerHTML = '<option value="">-- Select Ksheter --</option>';
      filteredKsheters.forEach(k => {
        ksheterSelect.innerHTML += `<option value="${k._id}">${k.name}</option>`;
      });
      kenderSelect.innerHTML = '<option value="">-- Select Kender --</option>';
    });

    ksheterSelect?.addEventListener('change', function () {
      const ksheterId = this.value;
      const filteredKenders = allKenders.filter(k => k.ksheter === ksheterId);
      kenderSelect.innerHTML = '<option value="">-- Select Kender --</option>';
      filteredKenders.forEach(k => {
        kenderSelect.innerHTML += `<option value="${k._id}">${k.name}</option>`;
      });
    });

    // Initial load
    toggleFields(roleSelect.value);
    roleSelect.addEventListener('change', () => toggleFields(roleSelect.value));
  });
</script>

<%- include('../partials/footer') %>
