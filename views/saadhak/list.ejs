<%- include('../partials/header') %>
<%- include('../partials/navbar') %>
<style>
  .pagination .page-link {
  padding: 0.25rem 0.5rem;
}
</style>
<section class="container mt-4">
  <!-- Header Row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold text-primary">üë• All Saadhaks</h4>
    <a href="/saadhak/add" class="btn btn-sm btn-success">‚ûï Add Saadhak</a>
  </div>

  <!-- Filters and Search -->
  <div class="row gy-3 mb-3">
    <div class="col-md-3">
      <label class="form-label">Prant</label>
      <select id="prantFilter" class="form-select">
        <option value="">Select Prant</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Zila</label>
      <select id="zilaFilter" class="form-select">
        <option value="">Select Zila</option>
        <% zilas.forEach(z => { %>
          <option value="<%= z._id %>"><%= z.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Ksheter</label>
      <select id="ksheterFilter" class="form-select">
        <option value="">Select Ksheter</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Kender</label>
      <select id="kenderFilter" class="form-select">
        <option value="">Select Kender</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Search (Any field)</label>
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="Name, Mobile, Role, etc.">
        <button id="searchBtn" class="btn btn-outline-primary">üîç Search</button>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <button id="resetBtn" class="btn btn-sm btn-outline-secondary">üîÑ Reset</button>
    <button id="exportCsvBtn" class="btn btn-sm btn-outline-success">üì• Export to CSV</button>
  </div>

  <!-- Data Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th style="white-space: nowrap; width: 1%;">#</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="saadhakTableBody"></tbody>
    </table>
  </div>

  <nav id="paginationNav" class="d-flex justify-content-center mt-3">
  <ul id="pagination" class="pagination pagination-sm"></ul>
</nav>
     
</section>

<!-- Script -->
<script>
  const allSaadhaks = <%- JSON.stringify(saadhaks) %>;
  const allKsheters = <%- JSON.stringify(ksheters) %>;
  const allKenders = <%- JSON.stringify(kenders) %>;
  const allZilas = <%- JSON.stringify(zilas) %>;
  const allPrant = <%- JSON.stringify(prants) %>;
  const user = <%- JSON.stringify(user) %>;
  let currentFilteredSaadhaks = [];
  let currentPage = 1;
  const pageSize = 50;

  document.addEventListener("DOMContentLoaded", function () {
    const prantFilter = document.getElementById("prantFilter");
    const zilaFilter = document.getElementById("zilaFilter");
    const ksheterFilter = document.getElementById("ksheterFilter");
    const kenderFilter = document.getElementById("kenderFilter");
    const resetBtn = document.getElementById("resetBtn");
    const tableBody = document.getElementById("saadhakTableBody");
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");

    // ---------- Populate Functions ----------
    function populateZila(prantId) {
      zilaFilter.innerHTML = '<option value="">All Zila</option>';
      const filtered = allZilas.filter(z => z.prant === prantId);
      filtered.forEach(z => {
        zilaFilter.innerHTML += `<option value="${z._id}">${z.name}</option>`;
      });
    }

    function populateKsheter(zilaId) {
      ksheterFilter.innerHTML = '<option value="">All Ksheter</option>';
      const filtered = allKsheters.filter(k => k.zila === zilaId);
      filtered.forEach(k => {
        ksheterFilter.innerHTML += `<option value="${k._id}">${k.name}</option>`;
      });
    }

    function populateKender(ksheterId) {
      kenderFilter.innerHTML = '<option value="">All Kender</option>';
      const filtered = allKenders.filter(k => k.ksheter === ksheterId);
      filtered.forEach(k => {
        kenderFilter.innerHTML += `<option value="${k._id}">${k.name}</option>`;
      });
    }

    // ---------- Populate Prant Dropdown Based on User ----------
    function populatePrant() {
      prantFilter.innerHTML = '<option value="">Select Prant</option>';
      const isAdmin = Array.isArray(user.roles) && user.roles.includes("Admin");

      if (isAdmin) {
        // Admin sees all prants
        allPrant.forEach(p => {
          prantFilter.innerHTML += `<option value="${p._id}">${p.name}</option>`;
        });
        prantFilter.disabled = false;
      } else {
        // Non-admin sees only their prant(s)
        let allowed = [];

        if (Array.isArray(user.prant)) {
          allowed = user.prant.map(x => (typeof x === 'object' && x?._id) ? x._id : x);
        } else if (user.prant) {
          allowed = [(typeof user.prant === 'object' && user.prant?._id) ? user.prant._id : user.prant];
        }

        const allowedPrants = allPrant.filter(p => allowed.includes(String(p._id)));
        allowedPrants.forEach(p => {
          prantFilter.innerHTML += `<option value="${p._id}">${p.name}</option>`;
        });

        if (allowedPrants.length === 1) {
          prantFilter.value = allowedPrants[0]._id;
          prantFilter.disabled = true;
        } else {
          prantFilter.disabled = false;
        }
      }

      if (prantFilter.value) {
        populateZila(prantFilter.value);
      }
    }

    // ---------- Initial Hierarchical Population ----------
    populatePrant();

 // ‚úÖ Role-based preselection and safe dropdown handling
if (user.roles.includes("Admin")) {
  // Admin: show all Prants initially
  prantFilter.innerHTML = '<option value="">All Prant</option>';
  allPrant.forEach(p => {
    prantFilter.innerHTML += `<option value="${p._id}">${p.name}</option>`;
  });

  // Keep all Zila, Ksheter, Kender dropdowns empty until a Prant is chosen
  zilaFilter.innerHTML = '<option value="">Select Zila</option>';
  ksheterFilter.innerHTML = '<option value="">Select Ksheter</option>';
  kenderFilter.innerHTML = '<option value="">Select Kender</option>';
} 
else {
  // Non-admin users: restrict dropdowns based on role
  if (user.prant) {
    prantFilter.value = user.prant;
    prantFilter.disabled = true;
    populateZila(user.prant);
  } else {
    zilaFilter.innerHTML = '<option value="">Select Zila</option>';
    ksheterFilter.innerHTML = '<option value="">Select Ksheter</option>';
    kenderFilter.innerHTML = '<option value="">Select Kender</option>';
  }

  if (user.zila) {
    zilaFilter.value = user.zila;
    zilaFilter.disabled = true;
    populateKsheter(user.zila);
  } else if (!user.prant) {
    ksheterFilter.innerHTML = '<option value="">Select Ksheter</option>';
    kenderFilter.innerHTML = '<option value="">Select Kender</option>';
  }

  if (user.ksheter) {
    ksheterFilter.value = user.ksheter;
    ksheterFilter.disabled = true;
    populateKender(user.ksheter);
  } else if (!user.zila) {
    kenderFilter.innerHTML = '<option value="">Select Kender</option>';
  }

  if (user.kender) {
    kenderFilter.value = user.kender;
    kenderFilter.disabled = true;
  }
}

    // ---------- Change Listeners ----------
    prantFilter.addEventListener("change", function () {
      populateZila(this.value);
      ksheterFilter.innerHTML = '<option value="">All Ksheter</option>';
      kenderFilter.innerHTML = '<option value="">All Kender</option>';
    });

    zilaFilter.addEventListener("change", function () {
      populateKsheter(this.value);
      kenderFilter.innerHTML = '<option value="">All Kender</option>';
    });

    ksheterFilter.addEventListener("change", function () {
      populateKender(this.value);
    });

    // ---------- Render Table ----------
    function renderTable() {
      const selectedPrant = prantFilter.value;
      const selectedZila = zilaFilter.value;
      const selectedKsheter = ksheterFilter.value;
      const selectedKender = kenderFilter.value;
      const searchTerm = searchInput.value.trim().toLowerCase();

      const ksheterRoles = ["Admin", "Zila Pradhan", "Zila Mantri", "Sangathan Mantri", "Cashier", "Ksheter Pradhan", "Ksheter Mantri"];
      const kenderMainTeam = ["Kender Pramukh", "Seh Kender Pramukh"];

      const filtered = allSaadhaks.filter(s => {
        const matchPrant = !selectedPrant || (s.prant && s.prant._id === selectedPrant);
        const matchZila = !selectedZila || (s.zila && s.zila._id === selectedZila);
        const matchKsheter = !selectedKsheter || (s.ksheter && s.ksheter._id === selectedKsheter);
        const matchKender = !selectedKender || (s.kender && s.kender._id === selectedKender);

        const inSearch =
          s.name?.toLowerCase().includes(searchTerm) ||
          s.mobile?.includes(searchTerm) ||
          (Array.isArray(s.role) && s.role.join(',').toLowerCase().includes(searchTerm)) ||
          s.zila?.name?.toLowerCase().includes(searchTerm) ||
          s.ksheter?.name?.toLowerCase().includes(searchTerm) ||
          s.kender?.name?.toLowerCase().includes(searchTerm) ||
          s.prant?.name?.toLowerCase().includes(searchTerm);

        let roleAllowed = true;
        if (user.roles.includes("Ksheter Pradhan") || user.roles.includes("Ksheter Mantri")) {
          roleAllowed = !s.role?.some(r => ksheterRoles.includes(r));
        }
        if (user.roles.includes("Kender Pramukh") || user.roles.includes("Seh Kender Pramukh")) {
          roleAllowed = !s.role?.some(r => [...ksheterRoles, ...kenderMainTeam].includes(r));
        }

        return matchPrant && matchZila && matchKsheter && matchKender && inSearch && roleAllowed;
      });

      currentFilteredSaadhaks = filtered;
      const totalPages = Math.ceil(filtered.length / pageSize);
      if (currentPage > totalPages) currentPage = 1;

      const start = (currentPage - 1) * pageSize;
      const paginated = filtered.slice(start, start + pageSize);
      tableBody.innerHTML = "";

      if (paginated.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No matching records found.</td></tr>';
        const pagination = document.getElementById("pagination");
        if (pagination) pagination.innerHTML = "";
        return;
      }

      paginated.forEach((s, index) => {
        const primaryRole = Array.isArray(s.role) ? s.role[0] : null;
        const badgeColor = primaryRole?.includes('Admin') ? 'dark' :
          primaryRole?.includes('Zila') ? 'danger' :
          primaryRole?.includes('Ksheter') ? 'primary' :
          primaryRole?.includes('Kender') ? 'success' :
          primaryRole?.includes('Shikshak') ? 'info' :
          primaryRole?.includes('Karyakarta') ? 'warning' : 'secondary';

        const rolesHtml = Array.isArray(s.role) && s.role.length > 0
          ? s.role.map(r => `<span class="badge bg-${badgeColor} me-1 mb-1">${r}</span>`).join('')
          : '<span class="text-muted">‚Äî</span>';

        tableBody.innerHTML += `
  <tr style="border: 2px solid black">
    <td style="border: 2px solid black" class="fw-bold">${start + index + 1}</td>
    <td class="position-relative">

      <div class="fw-bold text-primary d-flex align-items-center flex-wrap">
        <a href="/saadhak/edit/${s._id}" class="text-decoration-none text-success me-2">${s.name}</a>
        <span class="d-flex flex-wrap gap-1 me-2">${rolesHtml}</span>
      </div>
      <span class="text-danger fw-bold">${s.mobile || '‚Äî'}</span>

      <div class="text-dark small"><span class="text-primary fw-bold">${s.kender?.name || '‚Äî'}</span></div>
      <div class="text-dark small"><span class="fw-bold" style="color: orange;">${s.ksheter?.name || '‚Äî'}</span></div>
      <div class="text-dark small"><span class="text-dark fw-bold">${s.zila?.name || '‚Äî'}</span></div>

      <!-- ‚úÖ Prant line + edit/delete icons on same line -->
      <div class="text-dark small d-flex justify-content-between align-items-center">
        <span class="text-secondary fw-bold">${s.prant?.name || '‚Äî'}</span>
        <div class="d-flex gap-1">
          <a href="/saadhak/edit/${s._id}" class="btn btn-sm btn-outline-primary py-0 px-1" title="Edit">üñäÔ∏è</a>
          <button class="btn btn-sm btn-outline-danger py-0 px-1" data-bs-toggle="modal" data-bs-target="#deleteModal${s._id}" title="Delete">üóëÔ∏è</button>
        </div>
      </div>

      <div class="modal fade" id="deleteModal${s._id}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Confirm Delete</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Delete <strong>${s.name}</strong>?</div>
            <div class="modal-footer">
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              <a href="/saadhak/delete/${s._id}" class="btn btn-danger btn-sm">Yes, Delete</a>
            </div>
          </div>
        </div>
      </div>

    </td>
  </tr>`;

      });

      renderPagination(filtered.length);
    }

    // ---------- Pagination ----------
    function renderPagination(totalItems) {
      const pagination = document.getElementById("pagination");
      const totalPages = Math.ceil(totalItems / pageSize);
      pagination.innerHTML = "";
      if (totalPages <= 1) return;

      const createPageItem = (page, label = null, active = false, disabled = false) => {
        const li = document.createElement("li");
        li.className = `page-item${active ? " active" : ""}${disabled ? " disabled" : ""}`;
        const button = document.createElement("button");
        button.className = "page-link";
        button.textContent = label || page;
        button.disabled = disabled;
        if (!disabled && !active) {
          button.addEventListener("click", () => {
            currentPage = page;
            renderTable();
          });
        }
        li.appendChild(button);
        return li;
      };

      pagination.appendChild(createPageItem(currentPage - 1, "¬´", false, currentPage === 1));

      const maxVisible = 5;
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + maxVisible - 1);

      if (endPage - startPage < maxVisible - 1 && startPage > 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }

      if (startPage > 1) {
        pagination.appendChild(createPageItem(1));
        if (startPage > 2) {
          const dots = document.createElement("li");
          dots.className = "page-item disabled";
          dots.innerHTML = `<span class="page-link">‚Ä¶</span>`;
          pagination.appendChild(dots);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        pagination.appendChild(createPageItem(i, null, i === currentPage));
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dots = document.createElement("li");
          dots.className = "page-item disabled";
          dots.innerHTML = `<span class="page-link">‚Ä¶</span>`;
          pagination.appendChild(dots);
        }
        pagination.appendChild(createPageItem(totalPages));
      }

      pagination.appendChild(createPageItem(currentPage + 1, "¬ª", false, currentPage === totalPages));
    }

    // ---------- Export, Search & Reset ----------
    document.getElementById("exportCsvBtn").addEventListener("click", () => {
      const filtered = currentFilteredSaadhaks;
      if (filtered.length === 0) {
        alert("No matching records to export.");
        return;
      }
      const headers = ["S.No", "Name", "Mobile", "Email", "DOJ", "DOB", "DOM", "Prant", "Zila", "Ksheter", "Kender", "Roles", "Address"];
      const formatDate = (d) => (!d ? '' : new Date(d).toLocaleDateString('en-GB').replace(/\//g, '-'));
      const rows = filtered.map((s, i) => [
        i + 1, s.name || '', s.mobile || '', s.email || '',
        formatDate(s.doj), formatDate(s.dob), formatDate(s.marriageDate),
        s.prant?.name || '', s.zila?.name || '', s.ksheter?.name || '',
        s.kender?.name || '', Array.isArray(s.role) ? s.role.join(', ') : '', s.address || ''
      ]);
      const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.map(v => `"${(v || '').replace(/"/g, '""')}"`).join(",")).join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csvContent);
      link.download = "saadhaks_filtered.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    searchBtn.addEventListener("click", () => {
      currentPage = 1;
      renderTable();
    });

    resetBtn.addEventListener("click", () => {
      currentPage = 1;
      searchInput.value = "";
      const isAdmin = Array.isArray(user.roles) && user.roles.includes("Admin");
      if (isAdmin) {
        prantFilter.disabled = false;
        prantFilter.value = "";
        zilaFilter.innerHTML = '<option value="">Select Zila</option>';
        ksheterFilter.innerHTML = '<option value="">Select Ksheter</option>';
        kenderFilter.innerHTML = '<option value="">Select Kender</option>';
      } else {
        populatePrant();
      }
      tableBody.innerHTML = '';
      renderTable();
    });

    // ---------- Initial Render ----------
    renderTable();
  });
</script>


<%- include('../partials/footer') %>
