<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Full BYS Directory</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      font-size: 16px;
      padding: 40px;
      color: #1a1a1a;
      line-height: 1.6;
      background: #fff;
    }

    h1, h2, h3, h4 {
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 12px;
    }

    h1 {
      font-size: 30px;
      color: #0d47a1;
      border-bottom: 3px solid #0d47a1;
      padding-bottom: 10px;
      margin-bottom: 25px;
    }

    h2 {
      font-size: 24px;
      color: #1565c0;
      margin-top: 30px;
    }

    h3 {
      font-size: 20px;
      color: #1976d2;
      margin-top: 25px;
    }

    h4 {
      font-size: 18px;
      color: #2e7d32;
    }

    .section-title {
      background: #e3f2fd;
      padding: 12px 16px;
      margin-top: 30px;
      border-left: 6px solid #1976d2;
      page-break-inside: avoid;
    }

    .subsection {
      page-break-inside: avoid;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      margin-bottom: 30px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background-color: #f1f8ff;
      color: #0d47a1;
      font-weight: 600;
    }

    .team-table th {
      width: 25%;
    }

    .kender-box {
      margin-top: 20px;
      border: 1.5px solid #c8e6c9;
      padding: 14px;
      border-left: 6px solid #2e7d32;
      background-color: #f9fff9;
      page-break-inside: avoid;
    }

    .role-badge {
      display: inline-block;
      font-size: 13px;
      font-weight: bold;
      color: #fff;
      padding: 4px 10px;
      border-radius: 4px;
      margin: 2px 6px 2px 0;
      line-height: 1.4;
      text-transform: capitalize;
    }

    .Admin { background-color: #212121; }
    .Zila { background-color: #c62828; }
    .Ksheter { background-color: #1565c0; }
    .Kender { background-color: #2e7d32; }
    .Shikshak { background-color: #0288d1; }
    .Karyakarta { background-color: #fbc02d; color: #000; }

    .muted {
      color: #444;
      font-style: italic;
      font-size: 14px;
    }

    hr {
      border: none;
      border-top: 1.5px dashed #bbb;
      margin: 40px 0;
    }

    .zila-wrapper {
      page-break-after: always;
    }
  </style>
</head>
<body>
  <h1>üßò‚Äç‚ôÇÔ∏è Bhartiya Yog Sansthan - Full Directory</h1>
  <p><strong>Generated on:</strong> <%= new Date().toLocaleDateString() %></p>

  <% zilas.forEach(zila => { %>
    <div class="section-title">
      <h2>üó∫Ô∏è <%= zila.name %> Zila</h2>
    </div>

    <% const relatedKsheter = ksheters.filter(k => k.zila.toString() === zila._id.toString()); %>
    <% const relatedKenders = kenders.filter(k => k.zila.toString() === zila._id.toString()); %>
    <% const zilaTeam = saadhaks.filter(s =>
      s.zila && s.zila._id.toString() === zila._id.toString() &&
      ['Zila Pradhan', 'Zila Mantri', 'Sangathan Mantri', 'Cashier'].some(r => s.role.includes(r))
    ); %>

    <div class="subsection">
      <h3>üë• Zila Team</h3>
      <table class="team-table">
        <thead>
          <tr><th>Name</th><th>Roles</th><th>Mobile</th></tr>
        </thead>
        <tbody>
          <% zilaTeam.forEach(s => { %>
            <tr>
              <td><%= s.name %></td>
              <td>
                <% s.role.forEach(r => { %>
                  <span class="role-badge Zila"><%= r %></span>
                <% }) %>
              </td>
              <td><%= s.mobile %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <% relatedKsheter.forEach(ksheter => { %>
      <% const ksheterKenders = relatedKenders.filter(k => k.ksheter.toString() === ksheter._id.toString()); %>
      <% const ksheterTeam = saadhaks.filter(s =>
        s.ksheter && s.ksheter._id.toString() === ksheter._id.toString() &&
        ['Ksheter Pradhan', 'Ksheter Mantri'].some(r => s.role.includes(r))
      ); %>

      <div class="section-title">
        <h3>üèûÔ∏è <%= ksheter.name %> Ksheter</h3>
      </div>

      <% if (ksheterTeam.length > 0) { %>
        <div class="subsection">
          <h4>üë• Ksheter Team</h4>
          <table class="team-table">
            <thead>
              <tr><th>Name</th><th>Roles</th><th>Mobile</th></tr>
            </thead>
            <tbody>
              <% ksheterTeam.forEach(s => { %>
                <tr>
                  <td><%= s.name %></td>
                  <td>
                    <% s.role.forEach(r => { %>
                      <span class="role-badge Ksheter"><%= r %></span>
                    <% }) %>
                  </td>
                  <td><%= s.mobile %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>

      <% ksheterKenders.forEach(kender => { %>
        <% const kenderTeam = saadhaks.filter(s =>
          s.kender && s.kender._id.toString() === kender._id.toString() &&
          ['Kender Pramukh', 'Seh Kender Pramukh', 'Shikshak', 'Karyakarta'].some(r => s.role.includes(r))
        ); %>

        <div class="kender-box">
          <h4>üèïÔ∏è <%= kender.name %></h4>
          <p class="muted"><strong>Address:</strong> <%= kender.address || '‚Äî' %></p>

          <table class="team-table">
            <thead>
              <tr><th>Name</th><th>Roles</th><th>Mobile</th></tr>
            </thead>
            <tbody>
              <% kenderTeam.forEach(s => { %>
                <tr>
                  <td><%= s.name %></td>
                  <td>
                    <% s.role.forEach(r => { %>
                      <span class="role-badge 
                        <%= r.includes('Kender') ? 'Kender' :
                              r.includes('Shikshak') ? 'Shikshak' :
                              r.includes('Karyakarta') ? 'Karyakarta' : '' %>">
                        <%= r %>
                      </span>
                    <% }) %>
                  </td>
                  <td><%= s.mobile %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% }) %>
    <% }) %>
    <hr>
  <% }) %>
</body>
</html>
