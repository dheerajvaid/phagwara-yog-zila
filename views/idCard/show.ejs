<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
  /* ----------- CSS for High Visibility ID Card ----------- */
  .id-card-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .id-card-horizontal {
    width: 8.56cm;
    height: 5.40cm;
    display: flex;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border: 3px solid #3a120f;
    background: #fff4e0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
  }

  .id-card-horizontal::after {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.1);
    pointer-events: none;
  }

  .left-block {
    width: 25%;
    background: #fce5d0;
    padding: 4px 2px;
    text-align: center;
    border-right: 3px solid #3a120f;
    filter: contrast(110%);
  }

  .org-logo {
    width: 65px;
    margin-top: 10px;
    image-rendering: crisp-edges;
    filter: contrast(1.3) brightness(0.9);
  }

  .tagline {
    margin-top: 4px;
    font-size: 11px;
    font-weight: 800;
    color: #3a120f;
    text-shadow: 0 1px 2px rgba(255,255,255,0.5);
    text-rendering: geometricPrecision;
  }

  .right-block {
    width: 75%;
    padding: 8px;
    color: #4d1f12;
  }

  .org-title {
    font-size: 16px;
    font-weight: 800;
    text-align: center;
    color: #fff2e0;
    background-color: #3a120f;
    letter-spacing: 0.4px;
    padding: 2px 0;
  }

  .zila-title {
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    color: #3a120f;
    margin-bottom: 6px;
  }

  .info-box {
    background: #fce5d0;
    padding: 4px;
    border-radius: 10px;
    border: 2px solid #3a120f;
  }

  .info-label {
    font-size: 8px;
    opacity: 0.9;
    color: #5a1f0f;
    font-weight: 700;
  }

  .info-value {
    font-size: 13.5px;
    font-weight: 800;
    color: #3a120f;
    margin-bottom: 1px;
  }

  .divider {
    border-bottom: 1.5px solid #3a120f;
    margin: 1.5px 0;
    filter: contrast(120%);
  }

  .photo-box {
    width: 72px;
    height: 72px;
    border: 2px solid #3a120f;
    margin: 8px auto;
    background: #fff4e0;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    filter: contrast(115%);
  }

  .photo-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    image-rendering: crisp-edges;
  }

  #photoInput { display:none; }

  .download-container {
    text-align: center;
    margin-top: 25px;
  }

  @media print {
    body { margin:0; }
    .id-card-wrapper { margin-top:0; justify-content:flex-start; }
    .download-container { display:none; }
    .id-card-horizontal {
      box-shadow:none;
      border:2px solid #e0c9a7;
      -webkit-print-color-adjust:exact;
      print-color-adjust:exact;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div class="id-card-wrapper">
  <div id="card" class="id-card-horizontal">
    <!-- LEFT BLOCK -->
    <div class="left-block">
      <img src="/images/logo-nbg.png" class="org-logo" loading="lazy">
      <div class="tagline">‡§ú‡•Ä‡§ì ‡§î‡§∞ ‡§ú‡•Ä‡§µ‡§® ‡§¶‡•ã</div>
      <div class="photo-box" id="photoPreview">
        <span style="font-size:10px; color:#7a3e1f;">Photo</span>
      </div>
    </div>
    <!-- RIGHT BLOCK -->
    <div class="right-block">
      <div class="org-title">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§Ø‡•ã‡§ó ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§® (‡§™‡§Ç‡§ú‡•Ä.)</div>
      <div class="zila-title" style="line-height:1.05;">
        <% if (kenderName) { %><div><%= kenderName %></div><% } %>
        <% if (ksheterName) { %><div><%= ksheterName %></div><% } %>
        <% 
          let locationNames = [];
          if (zilaName) locationNames.push(zilaName);
          if (prantName) locationNames.push(prantName);
        %>
        <% if(locationNames.length > 0) { %>
          <div><%= locationNames.join(', ') %></div>
        <% } %>

        <% if (!kenderName && !ksheterName && !zilaName && !prantName) { %>
          <div>Karo Yog Raho Nirog</div>
        <% } %>
      </div>
      <div class="info-box">
        <div class="info-label">üë§ NAME</div>
        <div class="info-value"><%= user.name.toUpperCase() %></div>
        <div class="divider"></div>
        <div class="info-label">üéÄ DESIGNATION</div>
        <div class="info-value"><%= user.roles.join(", ") %></div>
        <div class="divider"></div>
        <div class="info-label">üì≤ MOBILE</div>
        <div class="info-value"><%= user.mobile.replace(/(\d{5})(\d{5})/, '$1-$2') %></div>
      </div>
    </div>
  </div>
</div>

<div class="download-container" style="display:flex; flex-direction:column; align-items:center; gap:10px;">
  <!-- Upload Photo -->
  <label for="photoInput" class="btn btn-warning">Upload Photo</label>
  <input type="file" accept="image/*" id="photoInput">

  <!-- Download Buttons -->
  <div class="download-buttons" style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; justify-content:center;">
    <button class="btn btn-success download-btn" onclick="downloadPNG()">Download PNG</button>
    <button class="btn btn-primary download-btn" onclick="downloadPDF()">Download PDF</button>
  </div>

  <!-- Note -->
  <p style="font-size:12px; margin-top:6px; color:#444; text-align:center;">
    üñ® <b>Note:</b> Print PDF at <b>100% / Actual Size</b> for correct ID card size.
  </p>
</div>


<script>
  // === Photo Preview ===
  document.getElementById('photoInput').addEventListener('change', function(event){
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      document.getElementById('photoPreview').innerHTML =
        `<img src="${e.target.result}" 
           style="width:100%; height:100%; object-fit:cover; 
                  image-rendering:crisp-edges; filter:contrast(1.18) brightness(0.95);">`;
    };
    reader.readAsDataURL(file);
  });

  // === Render Card Canvas ===
  async function renderCardCanvas(){
    const card = document.querySelector("#card");
    const originalRatio = window.devicePixelRatio;
    window.devicePixelRatio = 4;

    const canvas = await html2canvas(card,{
      scale:5,
      logging:false,
      useCORS:true,
      allowTaint:false,
      backgroundColor:null,
      removeContainer:true
    });

    window.devicePixelRatio = originalRatio;
    return canvas;
  }

  // === Download PNG ===
  async function downloadPNG(){
    const canvas = await renderCardCanvas();
    const pngData = canvas.toDataURL("image/png",1.0);
    const link = document.createElement("a");
    link.download = "id-card.png";
    link.href = pngData;
    link.click();
  }

  // === Download PDF ===
  async function downloadPDF(){
    const canvas = await renderCardCanvas();
    const { jsPDF } = window.jspdf;
    const pdfWidthCm = 8.56;
    const pdfHeightCm = 5.40;
    const pdf = new jsPDF({orientation:"landscape", unit:"cm", format:[pdfWidthCm,pdfHeightCm]});

    canvas.toBlob(async function(blob){
      const reader = new FileReader();
      reader.onload = function(){
        const jpegData = reader.result;
        pdf.addImage(jpegData,"JPEG",0,0,pdfWidthCm,pdfHeightCm,"","FAST");
        pdf.save("id-card.pdf");
      };
      reader.readAsDataURL(blob);
    },"image/jpeg",1.0);
  }
</script>

<%- include('../partials/footer') %>
