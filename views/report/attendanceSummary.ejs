<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container mt-2">
  <!-- Heading -->
  <h3 class="text-center mb-2 text-danger fw-bold fs-4">Attendance Summary Report</h3>

  <!-- Date Filter -->
  <form method="GET" class="text-center mb-2">
    <input type="date" name="date" id="date" value="<%= selectedDate %>" class="form-control d-inline w-auto fw-semibold" style="padding:3px 6px; font-size:0.9rem;" />

    <% if (user?.prant) { %>
      <input type="hidden" name="prant" value="<%= user.prant %>">
    <% } else if (requestData.query.prant) { %>
      <input type="hidden" name="prant" value="<%= requestData.query.prant[0] %>">
    <% } %>

    <% if (user?.zila) { %>
      <input type="hidden" name="zila" value="<%= user.zila %>">
    <% } else if (requestData.query.zila) { %>
      <input type="hidden" name="zila" value="<%= requestData.query.zila[0] %>">
    <% } %>
  </form>

  <!-- Export Button -->
  <div class="text-center mb-2">
    <button id="exportSummaryBtn" class="btn btn-danger btn-sm fw-semibold shadow" style="padding:4px 10px; font-size:0.85rem;">üì• Download Summary</button>
  </div>

  <!-- Exportable Area -->
  <div id="summaryExportWrapper" class="bg-white p-2 border rounded shadow-sm position-relative page-border" style="max-width: 950px; margin: auto;">

    <div class="text-center fw-bold fs-6 text-danger rounded bg-warning-subtle py-1">
      <span class="text-black fs-6">
        <%= new Date(selectedDate).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) %>
        (<%= new Date(selectedDate).toLocaleDateString('en-IN', { weekday: 'short' }) %>)
      </span>
    </div>

    <p class="bg-danger text-white fw-semibold text-center py-1 px-2 rounded" style="font-size:0.85rem;">
      <%= randomMessage %>
    </p>

    <!-- Watermark Logo -->
    <div class="watermark-logo"></div>

    <% for (let zila in summary) { const ksheters = Object.keys(summary[zila]); %>
      <div class="mb-3">
        <div class="d-flex align-items-center justify-content-center mb-2">
          <img src="/images/logo.jpg" alt="BYS Logo" style="height: 32px; margin-right: 8px;">
          <h5 class="text-danger fw-bold fs-5 m-0"><%= zila %></h5>
        </div>

        <% ksheters.forEach((ksheter, index) => { const isLast = index === ksheters.length - 1; const ksheterTotal = ksheterTotals[zila] && ksheterTotals[zila][ksheter]; if (ksheterTotal > 0) { %>
          <div class="mb-3 ms-1 me-1">

            <!-- Ksheter Name -->
            <table class="table table-bordered table-sm text-center" style="width: 95%; margin: auto;">
              <tr class="bg-warning-subtle fw-bold">
                <td class="py-1 fw-bold" style="text-transform: uppercase; font-size:1.1rem;">
                  <%= ksheter %>
                </td>
              </tr>
            </table>

            <!-- Kender Table -->
            <table class="table table-bordered table-sm" style="width: 100%; margin: auto;">
              <thead class="table-light text-center">
                <tr class="bg-warning-subtle text-dark">
                  <th style="width: 80%; font-size:0.85rem; padding:6px;">Kender Name</th>
                  <th style="width: 10%; font-size:1rem; padding:6px;">üß¢</th>
                  <th style="width: 10%; font-size:1rem; padding:6px;">üßòüèΩ</th>
                </tr>
              </thead>

              <tbody class="text-center">
                <% for (let kender in summary[zila][ksheter]) { if (summary[zila][ksheter][kender] !== 'unmarked') { %>
                  <tr>
                    <!-- Kender Name + Photos -->
                    <td class="text-start" style="font-size:0.85rem; padding:5px 6px;">
                      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <% const pramukhs = (kenderPhotosMap[kender] || []).filter(p => p.role.includes('Kender Pramukh')).sort((a,b)=>a.name.toLowerCase().localeCompare(b.name.toLowerCase())); %>
                        <% pramukhs.forEach(p => { %>
                          <img src="<%= p.photoUrl %>" alt="<%= p.name %>" title="<%= p.role %>: <%= p.name %>" crossorigin="anonymous" style="width:34px;height:42px;object-fit:cover;border-radius:4px;border:1.5px solid #dc3545;background:#f8f9fa;flex-shrink:0;">
                        <% }) %>
                        <span class="fw-bold"><%= kender %></span>
                      </div>
                    </td>

                    <!-- Cap Count -->
                    <td class="text-center" style="padding:5px 6px;">
                      <span class="bg-danger text-white fw-bold d-inline-flex align-items-center justify-content-center" style="min-width:26px;height:22px;border-radius:4px;">
                        <%= topperByName[kender] || 0 %>
                      </span>
                    </td>

                    <!-- Attendance -->
                    <td class="text-center" style="padding:5px 6px;">
                      <span class="text-black fw-bold fs-6"><%= summary[zila][ksheter][kender] %></span>
                    </td>
                  </tr>
                <% } } %>

                <!-- Ksheter Total -->
                <tr class="bg-danger text-white fw-bold text-center">
                  <td class="text-start text-white" style="font-size:0.85rem; padding:5px 6px;">
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center;"> <% const ksheterPradhans = (ksheterPhotosMap[ksheter] || []) .filter(p => p.role.includes("Ksheter Pradhan")) .sort((a,b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase())); const ksheterMantris = (ksheterPhotosMap[ksheter] || []) .filter(p => p.role.includes("Ksheter Mantri")) .sort((a,b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase())); %> <!-- Ksheter Pradhan first --> <% ksheterPradhans.forEach(p => { %> <img src="<%= p.photoUrl %>" title="<%= p.role %>: <%= p.name %>" alt="<%= p.name %>" crossorigin="anonymous" style=" width:30px; height:38px; object-fit:cover; border-radius:4px; border:1.5px solid #ffffff; background:#f8f9fa; flex-shrink:0; " > <% }) %> <!-- Ksheter Mantri next --> <% ksheterMantris.forEach(p => { %> <img src="<%= p.photoUrl %>" title="<%= p.role %>: <%= p.name %>" alt="<%= p.name %>" crossorigin="anonymous" style=" width:30px; height:38px; object-fit:cover; border-radius:4px; border:1.5px solid #ffffff; background:#f8f9fa; flex-shrink:0; " > <% }) %> <!-- Text --> <span class="fw-bold text-white"> <% if ( userRole === 'Admin' || userRole === 'Zila Pradhan' || userRole === 'Zila Mantri' || userRole === 'Zila Sangathan Mantri' || userRole === 'Zila Cashier' ) { %> Our Ksheter Total <% } else if ( userRole === 'Ksheter Pradhan' || userRole === 'Ksheter Mantri' ) { %> Our Ksheter Total <% } else { %> Kender Total <% } %> </span> </div> </td>
                  <td class="text-center">
                    <span class="bg-white text-danger fw-bold d-inline-flex align-items-center justify-content-center" style="min-width:26px;height:22px;border-radius:4px;">
                      <%  
                        let ksheterCapTotal = 0;
                        for (let k in summary[zila][ksheter]) {
                          ksheterCapTotal += topperByName[k] || 0;
                        }
                      %>
                      <%= ksheterCapTotal %>
                    </span>
                  </td>
                  <td class="text-white fw-bold" style="font-size:1.2rem;">
                    <%= ksheterTotals[zila]?.[ksheter] ?? 0 %>
                  </td>
                </tr>

                <% if (isLast) { %>
                  <tr class="bg-danger text-white fw-bold text-center">
                    <td class="text-center text-white" style="font-size:0.85rem;">Zila Total</td>
                    <td class="text-center">
                      <span class="bg-white text-danger fw-bold d-inline-flex align-items-center justify-content-center" style="min-width:26px;height:22px;border-radius:4px;">
                        <%
                          let zilaCapTotal = 0;
                          for (let ks in summary[zila]) {
                            for (let k in summary[zila][ks]) {
                              zilaCapTotal += topperByName[k] || 0;
                            }
                          }
                        %>
                        <%= zilaCapTotal %>
                      </span>
                    </td>
                    <td class="text-white fw-bold"><%= zilaTotals[zila] ?? 0 %></td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        <% } }); %>
      </div>
    <% } %>
  </div>
</div>

<!-- STYLES -->
<style>
  .page-border {
    border: 2px solid #dc3545 !important;
    padding: 6px !important;
  }

  #summaryExportWrapper table td,
  #summaryExportWrapper table th {
    font-size: 0.9rem !important;
    padding: 5px 6px !important;
    background-color: transparent !important;
    border: 1px solid #333 !important;
    position: relative;
    z-index: 1;
  }

  .watermark-logo::before {
    content: "";
    background-image: url('/images/logo.jpg');
    background-repeat: no-repeat;
    background-position: center;
    background-size: 420px auto;
    opacity: 0.10;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 0;
    pointer-events: none;
  }

  .bg-warning-subtle {
    background-color: #fff3cd !important;
  }

  @media screen and (max-width: 768px) {
    #summaryExportWrapper table td,
    #summaryExportWrapper table th {
      font-size: 0.85rem !important;
      padding: 4px !important;
    }

    .page-border {
      padding: 5px !important;
    }

    h5 {
      font-size: 1.1rem;
    }

    h6, .fs-6 {
      font-size: 1rem !important;
    }

    .btn, input[type="date"] {
      font-size: 0.85rem !important;
    }
  }
</style>

<!-- EXPORT SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('date').addEventListener('change', function() {
      var spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = 'block';
      }
      this.form.submit();
    });

    document.getElementById('exportSummaryBtn').addEventListener('click', () => {
    const exportArea = document.getElementById('summaryExportWrapper');
    // const watermarkText = document.getElementById('summaryWatermark');
    // watermarkText.style.display = 'block';

    setTimeout(() => {
      html2canvas(exportArea, {
  scale: 4,
  useCORS: true,
  allowTaint: true,
  backgroundColor: '#ffffff'
})
.then(canvas => {
        const link = document.createElement('a');
        link.download = `attendance_summary_<%= selectedDate %>.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        // watermarkText.style.display = 'none';
      });
    }, 300);
  });

  });
 
  
</script>

<%- include('../partials/footer') %>