<%- include('./partials/header') %>
<%- include('./partials/navbar') %>

<style>
  .dashboard-card {
    max-width: 420px;
    margin: 0 auto;
    background: #ffffff;
    padding: 2rem 1.5rem;
    border-radius: 1.5rem;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  }

  .dashboard-card h2 {
    font-size: 1.6rem;
    font-weight: bold;
    color: #1e88e5;
    margin-bottom: 0.5rem;
  }

  .dashboard-card p {
    font-size: 1rem;
    color: #6c757d;
  }

  /* NEW ‚Äî Compact button grid (2 per row) */
  .btn-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .btn-grid .btn {
    font-size: 1rem;
    padding: 0.7rem;
    border-radius: 0.65rem;
  }

  .dashboard-card .badge-calendar {
    position: absolute;
    top: 6px;
    right: 12px;
    font-size: 0.75rem;
    background-color: #dc3545;
    color: white;
    padding: 0.4em 0.6em;
    border-radius: 50%;
  }

  .progress {
    background-color: #e9ecef;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .progress-bar {
    transition: width 0.6s ease;
  }

  #notificationBar {
    max-width: 420px;
    margin: 1rem auto;
    background: linear-gradient(135deg, #1e88e5, #42a5f5);
    color: white;
    border-radius: 1rem;
    overflow: hidden;
    padding: 0.5rem 1rem;
    font-weight: 500;
    white-space: nowrap;
    position: relative;
  }

  #notificationText {
    display: inline-block;
    padding-left: 100%;
    animation: scroll 25s linear infinite;
  }

  #downloadTipBtn {
    background: linear-gradient(135deg, #28a745, #28a745);
    color: white;
    font-weight: bold;
  }

  #tipImageArea {
    background: white;
    padding: 1.5rem 0.5rem;
    border-radius: 1rem;
    border: 1px solid #dee2e6;
    max-width: 380px;
    margin: auto;
  }

  .kender-tip-box {
  background: #f8fff8;
  border: 1px solid #28a745;   /* thin border on all sides */
  border-left: 4px solid #28a745; /* thicker left border */
  border-radius: 8px;
  margin-top: 10px;
  padding: 4px 4px; /* balanced padding (top-bottom & left-right) */
}

.kender-tip-box p {
  font-size: 0.9rem;
  color: #000;
}


  .steps-box {
  background: linear-gradient(135deg, #00e3ae, #00b4d8, #0077b6);
  border-radius: 14px;
  padding: 14px 18px !important;
  color: #ffffff;
  font-weight: 700;
  box-shadow: 0 6px 14px rgba(0, 200, 180, 0.45);
  position: relative;
  overflow: hidden;
}

/* Glossy line */
.steps-box::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  background: linear-gradient(
    to bottom right,
    rgba(255, 255, 255, 0.22),
    rgba(255, 255, 255, 0.02)
  );
  mix-blend-mode: soft-light;
}

/* Shine streak */
.steps-box::after {
  content: "";
  position: absolute;
  top: -40%;
  left: -30%;
  width: 60%;
  height: 180%;
  background: rgba(255, 255, 255, 0.25);
  transform: rotate(25deg);
  filter: blur(20px);
}

  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  @media(max-width: 480px) {
    .dashboard-card {
      padding: 1.5rem 1rem;
      border-radius: 1rem;
    }

    .dashboard-card h2 {
      font-size: 1.4rem;
    }

    #notificationBar {
      font-size: 0.9rem;
    }
  }
</style>

<!-- Notifications Bar -->
<div id="notificationBar">
  <span id="notificationText"></span>
</div>

<!-- Tip of the Day Modal -->
<div class="modal fade" id="tipModal" tabindex="-1" aria-labelledby="tipModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-2" style="max-width: 400px; margin: auto;">

      <div class="modal-header bg-success text-white py-2">
        <h5 class="modal-title d-flex align-items-center gap-2" id="tipModalLabel">
          <div style="height: 44px; width: 44px; padding: 4px; border: 2px solid white; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center;">
            <img src="/images/logo.jpg" alt="Logo" style="width:100%; height:100%; object-fit:contain; border-radius:50%;">
          </div>
          <span>‡§Ü‡§ú ‡§ï‡§æ ‡§Ø‡•ã‡§ó ‡§∏‡§Ç‡§¶‡•á‡§∂</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center text-dark px-4 py-3">

        <div id="tipImageArea" class="bg-white text-dark"
             style="padding: 0.5rem; border: 2px solid #28a745; border-radius: 0rem; max-width: 350px; margin: auto; box-shadow: 0 0 12px rgba(0,0,0,0.08);">
          <!-- <div style="width:60px; padding:5px; border:2px solid #28a745; border-radius:8px; background-color:white; display:flex; align-items:center; justify-content:center;"> -->
              <img src="/images/logo.jpg" style="width:20%; object-fit:contain;margin:auto;">
            <!-- </div> -->
          <!-- ‚≠ê TOP SECTION WITH BYS LOGO + TITLE ‚≠ê -->
          <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
            

            <div>
              <div class="text-center text-primary fw-semibold">
                <p class="text-danger fw-bold mb-1 mt-0">BHARATIYA YOG SANSTHAN</p>
              </div>
              <h5 class="m-0 fw-bold text-success">‡§Ü‡§ú ‡§ï‡§æ ‡§Ø‡•ã‡§ó ‡§∏‡§Ç‡§¶‡•á‡§∂</h5>
              <div class="small text-dark">
                <%= new Date().toLocaleDateString('hi-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'long', year: 'numeric' }) %>
              </div>
            </div>
          </div>

          <!-- ‚≠ê USER PHOTO + NAME SECTION ‚≠ê -->
          <% if (user.photoUrl) { %>
            <div class="d-flex flex-column align-items-center mb-3" id="showHidePhoto">
              <div style="height: 90px; width: 70.87px; border-radius: 8px; overflow: hidden; border: 3px solid #28a745; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <img src="<%= user.photoUrl %>" alt="Photo" style="width:100%; height:100%; object-fit:cover;">
              </div>
              <div class="d-flex flex-column mt-2 fw-bold text-danger" style="font-size:1.1rem;">
                <div><%= user.name %></div>
                <div style="font-size:0.8rem; color:#000;">(<%= user.roles %>)</div>
              </div>
            </div>
          <% } %>

          <hr style="border-top:2px solid #28a745; margin-bottom:0.5rem;">

          <!-- ‚≠ê TIP TEXT (Display Mode) ‚≠ê -->
          <div id="tipDisplayArea">
            <p class="fs-5 mb-2 fst-italic" id="tipText" style="color:black;"><%= tipOfTheDay %></p>
          </div>

          <!-- ‚≠ê TIP TEXT (Edit Mode) - Hidden by default ‚≠ê -->
          <div id="tipEditArea" style="display: none;">
            <textarea id="tipTextarea" class="form-control mb-2" rows="4" 
                      style="border: 2px solid #28a745; border-radius: 8px; font-style: italic;"
                      placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç..."></textarea>
            <div class="d-flex justify-content-center gap-2">
              <button type="button" class="btn btn-success btn-sm" id="confirmEditBtn">
                ‚úì ‡§†‡•Ä‡§ï ‡§π‡•à
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="cancelEditBtn">
                ‚úó ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
              </button>
            </div>
          </div>

          <% if (!user.photoUrl) { %>
            <p class="text-center text-success fw-bold mb-0">- <%= user.name %></p>
          <% } %>

          <!-- ‚≠ê KENDER INFO SECTION ‚≠ê -->
          <%
            const kenderRoles = ['Kender Pramukh', 'Seh Kender Pramukh', 'Shikshak', 'Karyakarta', 'Saadhak'];
            const isKenderUser = user.roles && user.roles.some(r => kenderRoles.includes(r));
          %>

          <% if (isKenderUser && kenderDetails) { %>
            <div class="kender-tip-box mt-3 p-3 rounded shadow-sm"
                 style="background:#f8fff4; border-left:5px solid #28a745; line-height:1.35;">
              <div class="fw-bold"><%= kenderDetails.name %></div>
              <div><%= kenderDetails.address %></div>
              <% if (kenderDetails.startTime) { %>
                <div>Start‚è∞: <%= kenderDetails.startTime %></div>
              <% } %>
            </div>
          <% } %>

          <!-- FOOTER LINK -->
          <div class="mt-1 text-center text-primary fw-semibold">
            <a href="https://www.joinyog.in" target="_blank" class="text-decoration-none text-danger">
              www.joinyog.in
            </a>
          </div>

        </div>

      </div>

      <div class="modal-footer justify-content-center py-2">
        <button type="button" class="btn btn-success" id="downloadTipBtn">‚¨áÔ∏è Download</button>
        <button type="button" class="btn btn-outline-success" id="customizeTextBtn">‚úèÔ∏è Customize Text</button>
        <button type="button" class="btn btn-outline-success" id="showHidePhotoBtn">Hide Photo</button>
        <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">üôè ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶</button>
      </div>

    </div>
  </div>
</div>


<section class="container mt-1 text-center">
  <div class="dashboard-card">

    <h2>üßòüèª Yogi <%= user.name %></h2>
    <p class="mb-1">Your mobile: <strong><%= user.mobile %></strong></p>

    <% if (typeof bmi !== 'undefined' && bmi) { %>
      <p class="mb-2">
        <strong>BMI:</strong> <%= bmi %>
        (<span class="<%= bmiCategory === 'Normal' ? 'text-success' : 'text-danger' %>"><%= bmiCategory %></span>)
      </p>

      <div class="progress" style="height: 12px; max-width: 300px; margin: 0.5rem auto;">
        <div class="progress-bar 
          <% if(bmiCategory === 'Normal'){ %> bg-success <% } else { %> bg-danger <% } %>"
          role="progressbar"
          style="width: <%= Math.min((bmi / 40) * 100, 100).toFixed(2) %>%"
          aria-valuenow="<%= bmi %>" aria-valuemin="0" aria-valuemax="40">
        </div>
      </div>
    <% } %>

    <%
  // If todaySteps is undefined or null, set it to 0
  const stepsToday = (typeof todaySteps !== 'undefined' && todaySteps !== null) 
                      ? todaySteps 
                      : 0;
%>

<div class="steps-box p-2 mb-2 mt-2 rounded fw-bold text-white">
  Today's Steps: 
  <span class="fw-bold"><%= stepsToday.toLocaleString() %> üö∂</span>
</div>


    <!-- NEW: Compact 2-per-row Button Grid -->
    <div class="btn-grid">

        <!-- NEW BUTTONS -->
      <a href="/paath/add" class="btn btn-primary shadow-sm">üö∂‚Äç‚ôÇÔ∏è Enter Steps</a>

      <% if (user.roles && user.roles.some(r =>
            ['Kender Pramukh', 'Seh Kender Pramukh', 'Shikshak', 'Karyakarta'].includes(r)) 
            || user.kender === '68c82ad93cec3c399e196373') { %>
        <a href="/attendance/mark" class="btn btn-success shadow-sm">‚úÖ Attendance</a>
      <% } %>

      <a href="/attendance/top10" class="btn btn-danger shadow-sm">üîù Attendance</a>     

      <a href="/calendar/today" class="btn btn-info shadow-sm position-relative">
        üìÖ Birthday
        <% if (typeof eventCount !== 'undefined' && eventCount > 0) { %>
          <span class="badge-calendar"><%= eventCount %></span>
        <% } %>
      </a>

       <a href="/saadhak/self-update"
         class="btn text-white shadow-sm fw-bold"
         style="background: linear-gradient(135deg, #ff6a00, #ee0979); border:none;">
        ‚úèÔ∏è My Details
      </a>

      <a href="/auth/change-password" class="btn btn-warning shadow-sm">üîê Password</a>
      <a href="/auth/logout" class="btn btn-danger shadow-sm">üö™ Logout</a>
    
      
    </div>

    <a href="/idcard/<%= userId %>" class="btn btn-primary w-100 mt-2">
        Generate My ID Card
    </a>

    
    <% if (user.roles && user.roles.some(r =>
            ['Zila Pradhan', 'Zila Mantri', 'Zila Sangathan Mantri', 'Zila Cashier'].includes(r))) { %>
    <a href="/idcard/zila/<%= user.zila %>" class="btn btn-dark w-100 mt-2">
      Generate Zila & Ksheter ID Cards
    </a>

    <a href="/idcard/zila/<%= user.zila %>?all=1" class="btn btn-success w-100 mt-2">
      Generate ALL Roles ID Cards
    </a>
    <% } %>

  </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tipText = document.getElementById('tipText');
  const tipDisplayArea = document.getElementById('tipDisplayArea');
  const tipEditArea = document.getElementById('tipEditArea');
  const tipTextarea = document.getElementById('tipTextarea');
  const customizeTextBtn = document.getElementById('customizeTextBtn');
  const confirmEditBtn = document.getElementById('confirmEditBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const showHidePhoto = document.getElementById('showHidePhoto');
  const showHidePhotoBtn = document.getElementById('showHidePhotoBtn');

  // Store original tip
  const originalTip = tipText ? tipText.textContent : '';

  // Tip modal show (keep behavior)
  window.addEventListener("load", () => {
    const modalEl = document.getElementById('tipModal');
    if (window.bootstrap && modalEl) {
      const tipModal = new bootstrap.Modal(modalEl);
      tipModal.show();
    }
  });

  // Notifications (keep behavior)
  const notifications = ["üéâ New Feature: Please Update Kender Creation Date under the menu Update Kender Details! or Edit Kender Details"];
  let notifIdx = 0;
  const notifText = document.getElementById("notificationText");

  function showNextNotification() {
    if (!notifText) return;
    notifText.textContent = notifications[notifIdx];
    notifIdx = (notifIdx + 1) % notifications.length;
  }

  showNextNotification();
  setInterval(showNextNotification, 16000);

  // Download button (keep behavior)
  const downloadBtn = document.getElementById("downloadTipBtn");
  if (downloadBtn) {
    downloadBtn.addEventListener("click", function () {
      const tipElement = document.getElementById("tipImageArea");
      if (!tipElement || !window.html2canvas) return;

      html2canvas(tipElement, {
        backgroundColor: '#ffffff',
        scale: 4,
        useCORS: true
      }).then(canvas => {
        const link = document.createElement("a");
        const today = new Date().toLocaleDateString('en-CA');
        link.download = `Aaj-Ka-Sandesh-${today}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    });
  }

  // ‚úÖ Show/Hide Photo (fixed)
  if (showHidePhoto && showHidePhotoBtn) {
    // If you start with inline style="display:none", convert it into Bootstrap's d-none
    if (showHidePhoto.style.display === 'none') {
      showHidePhoto.style.display = '';
      showHidePhoto.classList.add('d-none'); // display:none !important
    }

    // Sync initial button text with current visibility
    const initiallyHidden = showHidePhoto.classList.contains('d-none')
      || window.getComputedStyle(showHidePhoto).display === 'none';
    showHidePhotoBtn.textContent = initiallyHidden ? 'Show Photo' : 'Hide Photo';

    showHidePhotoBtn.addEventListener('click', function () {
      const isHidden = showHidePhoto.classList.contains('d-none')
        || window.getComputedStyle(showHidePhoto).display === 'none';

      if (isHidden) {
        showHidePhoto.classList.remove('d-none');
        showHidePhotoBtn.textContent = 'Hide Photo';
      } else {
        showHidePhoto.classList.add('d-none');
        showHidePhotoBtn.textContent = 'Show Photo';
      }
    });
  }

  // Tip edit (keep behavior)
  if (customizeTextBtn && tipTextarea && tipText && tipDisplayArea && tipEditArea) {
    customizeTextBtn.addEventListener('click', function () {
      tipTextarea.value = tipText.textContent;
      tipDisplayArea.style.display = 'none';
      tipEditArea.style.display = 'block';
      tipTextarea.focus();
      tipTextarea.select();
    });
  }

  if (confirmEditBtn && tipTextarea && tipText && tipDisplayArea && tipEditArea) {
    confirmEditBtn.addEventListener('click', function () {
      const newText = tipTextarea.value.trim();
      if (newText) tipText.textContent = newText;
      tipEditArea.style.display = 'none';
      tipDisplayArea.style.display = 'block';
    });
  }

  if (cancelEditBtn && tipDisplayArea && tipEditArea) {
    cancelEditBtn.addEventListener('click', function () {
      tipEditArea.style.display = 'none';
      tipDisplayArea.style.display = 'block';
    });
  }
});
</script>


<%- include('./partials/footer') %>
