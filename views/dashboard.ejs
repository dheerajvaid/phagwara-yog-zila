<%- include('./partials/header') %>
<%- include('./partials/navbar') %>

<style>
  .dashboard-card {
    max-width: 420px;
    margin: 0 auto;
    background: #ffffff;
    padding: 2rem 1.5rem;
    border-radius: 1.5rem;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  }

  .dashboard-card h2 {
    font-size: 1.6rem;
    font-weight: bold;
    color: #1e88e5;
    margin-bottom: 0.5rem;
  }

  .dashboard-card p {
    font-size: 1rem;
    color: #6c757d;
  }

  /* NEW ‚Äî Compact button grid (2 per row) */
  .btn-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .btn-grid .btn {
    font-size: 1rem;
    padding: 0.7rem;
    border-radius: 0.65rem;
  }

  .dashboard-card .badge-calendar {
    position: absolute;
    top: 6px;
    right: 12px;
    font-size: 0.75rem;
    background-color: #dc3545;
    color: white;
    padding: 0.4em 0.6em;
    border-radius: 50%;
  }

  .progress {
    background-color: #e9ecef;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .progress-bar {
    transition: width 0.6s ease;
  }

  #notificationBar {
    max-width: 420px;
    margin: 1rem auto;
    background: linear-gradient(135deg, #1e88e5, #42a5f5);
    color: white;
    border-radius: 1rem;
    overflow: hidden;
    padding: 0.5rem 1rem;
    font-weight: 500;
    white-space: nowrap;
    position: relative;
  }

  #notificationText {
    display: inline-block;
    padding-left: 100%;
    animation: scroll 25s linear infinite;
  }

  #downloadTipBtn {
    background: linear-gradient(135deg, #28a745, #28a745);
    color: white;
    font-weight: bold;
  }

  #tipImageArea {
    background: white;
    padding: 1.5rem 1rem;
    border-radius: 1rem;
    border: 1px solid #dee2e6;
    max-width: 340px;
    margin: auto;
  }

  .steps-box {
  background: linear-gradient(135deg, #00e3ae, #00b4d8, #0077b6);
  border-radius: 14px;
  padding: 14px 18px !important;
  color: #ffffff;
  font-weight: 700;
  box-shadow: 0 6px 14px rgba(0, 200, 180, 0.45);
  position: relative;
  overflow: hidden;
}

/* Glossy line */
.steps-box::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  background: linear-gradient(
    to bottom right,
    rgba(255, 255, 255, 0.22),
    rgba(255, 255, 255, 0.02)
  );
  mix-blend-mode: soft-light;
}

/* Shine streak */
.steps-box::after {
  content: "";
  position: absolute;
  top: -40%;
  left: -30%;
  width: 60%;
  height: 180%;
  background: rgba(255, 255, 255, 0.25);
  transform: rotate(25deg);
  filter: blur(20px);
}

  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  @media(max-width: 480px) {
    .dashboard-card {
      padding: 1.5rem 1rem;
      border-radius: 1rem;
    }

    .dashboard-card h2 {
      font-size: 1.4rem;
    }

    #notificationBar {
      font-size: 0.9rem;
    }
  }
</style>

<!-- Notifications Bar -->
<div id="notificationBar">
  <span id="notificationText"></span>
</div>

<!-- Tip of the Day Modal -->
<div class="modal fade" id="tipModal" tabindex="-1" aria-labelledby="tipModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-2" style="max-width: 400px; margin: auto;">

      <div class="modal-header bg-success text-white py-2">
        <h5 class="modal-title d-flex align-items-center gap-2" id="tipModalLabel">
          <div style="height: 44px; width: 44px; padding: 4px; border: 2px solid white; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center;">
            <img src="/images/logo.jpg" alt="Logo" style="width:100%; height:100%; object-fit:contain; border-radius:50%;">
          </div>
          <span>‡§Ü‡§ú ‡§ï‡§æ ‡§Ø‡•ã‡§ó ‡§∏‡§Ç‡§¶‡•á‡§∂</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center text-dark px-4 py-3">

        <div id="tipImageArea" class="bg-white text-dark"
             style="padding: 1.5rem; border: 2px solid #28a745; border-radius: 0rem; max-width: 350px; margin: auto; box-shadow: 0 0 12px rgba(0,0,0,0.08);">

          <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
            <div style="width:60px; height:60px; padding:5px; border:2px solid #28a745; border-radius:50%; background-color:white; display:flex; align-items:center; justify-content:center;">
              <img src="/images/logo.jpg" style="width:100%; height:100%; object-fit:contain; border-radius:50%;">
            </div>

            <div>
              <h5 class="m-0 fw-bold text-success">‡§Ü‡§ú ‡§ï‡§æ ‡§Ø‡•ã‡§ó ‡§∏‡§Ç‡§¶‡•á‡§∂</h5>
              <div class="small text-dark">
                <%= new Date().toLocaleDateString('hi-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
              </div>
            </div>
          </div>

          <hr style="border-top:2px solid #28a745; margin-bottom:0.5rem;">

          <p class="fs-5 mb-2 fst-italic" style="color:black;"><%= tipOfTheDay %></p>

          <p class="text-center text-success fw-bold mb-0">- <%= user.name %></p>

          <hr style="border-top:2px solid #28a745; margin-bottom:0.5rem; margin-top:0.5rem;">

          <div class="mt-1 text-center text-primary fw-semibold">
            <p class="text-danger fw-bold mb-0">BHARATIYA YOG SANSTHAN</p>
            <a href="https://www.joinyog.in" target="_blank" class="text-decoration-none text-danger">
              www.joinyog.in
            </a>
          </div>
        </div>

      </div>

      <div class="modal-footer justify-content-center py-2">
        <button type="button" class="btn btn-success" id="downloadTipBtn">‚¨áÔ∏è Download</button>
        <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">üôè ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶</button>
      </div>

    </div>
  </div>
</div>

<section class="container mt-1 text-center">
  <div class="dashboard-card">

    <h2>üßòüèª Yogi <%= user.name %></h2>
    <p class="mb-1">Your mobile: <strong><%= user.mobile %></strong></p>

    <% if (typeof bmi !== 'undefined' && bmi) { %>
      <p class="mb-2">
        <strong>BMI:</strong> <%= bmi %>
        (<span class="<%= bmiCategory === 'Normal' ? 'text-success' : 'text-danger' %>"><%= bmiCategory %></span>)
      </p>

      <div class="progress" style="height: 12px; max-width: 300px; margin: 0.5rem auto;">
        <div class="progress-bar 
          <% if(bmiCategory === 'Normal'){ %> bg-success <% } else { %> bg-danger <% } %>"
          role="progressbar"
          style="width: <%= Math.min((bmi / 40) * 100, 100).toFixed(2) %>%"
          aria-valuenow="<%= bmi %>" aria-valuemin="0" aria-valuemax="40">
        </div>
      </div>
    <% } %>

    <%
  // If todaySteps is undefined or null, set it to 0
  const stepsToday = (typeof todaySteps !== 'undefined' && todaySteps !== null) 
                      ? todaySteps 
                      : 0;
%>

<div class="steps-box p-2 mb-2 mt-2 rounded fw-bold text-white">
  Today's Steps: 
  <span class="fw-bold"><%= stepsToday.toLocaleString() %> üö∂</span>
</div>


    <!-- NEW: Compact 2-per-row Button Grid -->
    <div class="btn-grid">

        <!-- NEW BUTTONS -->
      <a href="/paath/add" class="btn btn-primary shadow-sm">üö∂‚Äç‚ôÇÔ∏è Enter Steps</a>

      <% if (user.roles && user.roles.some(r =>
            ['Kender Pramukh', 'Seh Kender Pramukh', 'Shikshak', 'Karyakarta'].includes(r)) 
            || user.kender === '68c82ad93cec3c399e196373') { %>
        <a href="/attendance/mark" class="btn btn-success shadow-sm">‚úÖ Attendance</a>
      <% } %>

      <a href="/attendance/top10" class="btn btn-danger shadow-sm">üîù Attendance</a>

     

      <a href="/calendar/today" class="btn btn-info shadow-sm position-relative">
        üìÖ Birthday
        <% if (typeof eventCount !== 'undefined' && eventCount > 0) { %>
          <span class="badge-calendar"><%= eventCount %></span>
        <% } %>
      </a>

       <a href="/saadhak/self-update"
         class="btn text-white shadow-sm fw-bold"
         style="background: linear-gradient(135deg, #ff6a00, #ee0979); border:none;">
        ‚úèÔ∏è My Details
      </a>

      <a href="/auth/change-password" class="btn btn-warning shadow-sm">üîê Password</a>
      <a href="/auth/logout" class="btn btn-danger shadow-sm">üö™ Logout</a>
    
      
    </div>

  </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  window.addEventListener("load", () => {
    const tipModal = new bootstrap.Modal(document.getElementById('tipModal'));
    tipModal.show();
  });

  const notifications = ["üéâ New Feature: Please Update Kender Creation Date under the menu Update Kender Details! or Edit Kender Details"];
  let notifIdx = 0;
  const notifText = document.getElementById("notificationText");

  function showNextNotification() {
    notifText.textContent = notifications[notifIdx];
    notifIdx = (notifIdx + 1) % notifications.length;
  }

  showNextNotification();
  setInterval(showNextNotification, 16000);

  document.getElementById("downloadTipBtn").addEventListener("click", function () {
    const tipElement = document.getElementById("tipImageArea");

    html2canvas(tipElement, {
      backgroundColor: '#ffffff',
      scale: 4,
      useCORS: true
    }).then(canvas => {
      const link = document.createElement("a");
      const today = new Date().toLocaleDateString('en-CA');
      link.download = `Aaj-Ka-Sandesh-${today}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  });
</script>

<%- include('./partials/footer') %>
