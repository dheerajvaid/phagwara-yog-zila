<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
  .big-checkbox {
    width: 1.5rem;
    height: 1.5rem;
    border: 2px solid #000;
    background-color: #fff;
  }

  .big-checkbox:checked {
    background-color: #007bff;
    border-color: #0056b3;
  }

  .form-check-label {
    font-size: 1.2rem;
    color: #000;
  }
</style>


<div class="container mt-3">
  <div id="attendanceWrapper">
    <h4 class="text-center mb-3 fw-bold border-bottom pb-2">üìä View Saadhak/Adhikari Attendance (Monthly)</h4>

    <!-- Dropdown Form -->
<form id="attendanceCapture" method="GET" action="/attendance/view" class="row g-3 mb-4 p-3 bg-light border rounded shadow-sm">
  
  <!-- Adhikari Checkbox -->
  <div class="col-12">
    <div class="d-flex align-items-center">
      <input 
        class="form-check-input big-checkbox me-2" 
        type="checkbox" 
        id="adhikariCheckbox" 
        name="roleType" 
        value="adhikari"
      >
      <label 
        class="form-check-label fw-bold fs-5 mb-0" 
        for="adhikariCheckbox"
      >
        üìã Adhikari Attendance
      </label>
    </div>
  </div>

  <!-- Scope Dropdowns --> 
  <div class="col-12">
    <div id="scopeDropdownsContainer">
      <%- include('../partials/scope-dropdowns') %>
    </div>
  </div>

  <!-- Month & Year -->
  <div class="col-6 col-md-3">
    <label class="form-label fw-semibold">üìÖ Month</label>
    <select name="month" class="form-control" required>
      <option value="">Select Month</option>
      <% for (let m = 1; m <= 12; m++) { %>
        <option value="<%= m %>" <%= selectedMonth == m ? 'selected' : '' %>>
          <%= new Date(2000, m-1).toLocaleString('default', { month: 'long' }) %>
        </option>
      <% } %>
    </select>
  </div>

  <div class="col-6 col-md-3">
    <label class="form-label fw-semibold">üìÜ Year</label>
    <select name="year" class="form-control" required>
      <option value="">Select Year</option>
      <% for (let y = 2025; y <= 2030; y++) { %>
        <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
      <% } %>
    </select>
  </div>

  <!-- Sort Dropdown -->
  <div class="col-12 col-md-3">
    <label class="form-label fw-semibold">üîΩ Sort By</label>
    <select name="sortBy" class="form-control" onchange="document.getElementById('attendanceForm').submit()">
      <option value="name" <%= sortBy === 'name' ? 'selected' : '' %>>Name</option>
      <option value="count" <%= sortBy === 'count' ? 'selected' : '' %>>Present Days</option>
    </select>
  </div>

  <!-- Submit -->
  <div class="col-12 col-md-3 d-flex align-items-end">
    <button class="btn btn-primary w-100 fw-semibold">üîç View</button>
  </div>

</form>

    <% if (attendanceData.length) { %>
      <div class="text-end mb-2">
        <button id="exportPdfBtn" class="btn btn-sm btn-danger">üìÑ Export as PDF</button>
      </div>

      <% 
        const dayPresentCount = {};
        activeDays.forEach(day => dayPresentCount[day] = 0);
        attendanceData.forEach(s => {
          s.attendance.forEach(dateStr => {
            const day = parseInt(dateStr.split("-")[2]);
            if (dayPresentCount[day] !== undefined) {
              dayPresentCount[day]++;
            }
          });
        });
      %>

      <!-- Attendance Table -->
      <div class="custom-scroll table-responsive-sm" style="max-height: 400px; overflow-x: auto; overflow-y: auto;">
        <table class="table table-bordered table-sm text-center align-middle" style="border: 1px solid #999;">
          <thead class="thead-light bg-light border" style="border: 1px solid #777;">
            <tr>
              <th class="bg-primary text-white">Date</th>
              <% activeDays.forEach(day => { %>
                <th style="width: 32px; font-size: 0.85rem;" class="bg-primary text-white border"><%= day %></th>
              <% }) %>
            </tr>
            <tr>
              <th class="text-primary fw-bold bg-light">Total Present</th>
              <% activeDays.forEach(day => { %>
                <th style="width: 32px;" class="text-primary fw-bold bg-light border"><%= dayPresentCount[day] %></th>
              <% }) %>
            </tr>
          </thead>
          <tbody>
            <% attendanceData.forEach(s => { %>
              <tr style="page-break-inside: avoid;">
                <td class="fw-bold" style="white-space: nowrap; font-size: 0.85rem; width: 1%;">
                  <a href="/attendance/details/<%= s._id %>?month=<%= selectedMonth %>&year=<%= selectedYear %>" class="fw-bold text-primary">
                    <%= s.name %>
                  </a>
                  <span class="text-danger">(<%= s.presentCount %>)</span>
                </td>
                <% activeDays.forEach(day => {
                  const dateStr = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                  const isPresent = s.attendance.includes(dateStr);
                %>
                  <td class="<%= isPresent ? 'bg-success text-white' : 'bg-light text-black' %>"
                      style="width: 30px; min-width: 30px; max-width: 30px; font-size: 0.8rem; padding: 4px;">
                    <%= day %>
                  </td>
                <% }) %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Hidden container for PDF export -->
      <div id="pdfCloneContainer" style="position: absolute; left: -9999px; top: -9999px;"></div>
    <% } else if (selectedKender) { %>
      <p class="text-muted text-center">No attendance data found for selected month.</p>
    <% } %>
  </div>
</div>

<!-- PDF EXPORT Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  document.getElementById("exportPdfBtn")?.addEventListener("click", function () {
    const originalTable = document.querySelector(".custom-scroll table");
    const cloneContainer = document.getElementById("pdfCloneContainer");

    cloneContainer.innerHTML = '';

    const clone = originalTable.cloneNode(true);
    clone.style.width = '100%';

    const wrapper = document.createElement('div');

    const heading = document.createElement('h4');
    heading.innerText = "üìä <%= selectedKenderName %> - Attendance Report - <%= selectedMonth %>/<%= selectedYear %>";
    heading.style.textAlign = "center";


    const style = document.createElement('style');
    style.textContent = `
      table { border-collapse: collapse; width: 100%; }
      tr { page-break-inside: avoid !important; break-inside: avoid; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      th, td { border: 1px solid #888 !important; padding: 4px;}
    `;

    wrapper.appendChild(style);
    wrapper.appendChild(heading);
    wrapper.appendChild(clone);
    cloneContainer.appendChild(wrapper);

    const opt = {
      margin:       0.3,
      filename:     'Attendance_<%= selectedMonth %>_<%= selectedYear %>.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, scrollY: 0 },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
    };

    html2pdf().set(opt).from(wrapper).save();
  });
</script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const requiredFields = ['prant', 'zila', 'ksheter', 'kender'];
    const scopeContainer = document.getElementById('scopeDropdownsContainer');
    const adhikariCheckbox = document.getElementById('adhikariCheckbox');

    // Initially make dropdowns required
    requiredFields.forEach(field => {
      const dropdown = document.getElementById(`${field}Dropdown`);
      if (dropdown) dropdown.setAttribute('required', 'required');
    });

    // Handle checkbox change
    if (adhikariCheckbox) {
      adhikariCheckbox.addEventListener('change', () => {
        if (adhikariCheckbox.checked) {
          scopeContainer.style.display = 'none';
          requiredFields.forEach(field => {
            const dropdown = document.getElementById(`${field}Dropdown`);
            if (dropdown) dropdown.removeAttribute('required');
          });
        } else {
          scopeContainer.style.display = 'block';
          requiredFields.forEach(field => {
            const dropdown = document.getElementById(`${field}Dropdown`);
            if (dropdown) dropdown.setAttribute('required', 'required');
          });
        }
      });

      // Optional: handle page load if checkbox is already checked
      if (adhikariCheckbox.checked) {
        scopeContainer.style.display = 'none';
        requiredFields.forEach(field => {
          const dropdown = document.getElementById(`${field}Dropdown`);
          if (dropdown) dropdown.removeAttribute('required');
        });
      }
    }
  });
</script>


<%- include('../partials/footer') %>
