<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
  /* ---------------- TABLE BASE ---------------- */
.summary-table {
  border-collapse: separate !important;
  border-spacing: 0 6px !important;
  background: #fafafa !important;
  padding: 10px;
  border-radius: 8px;
}

.summary-table td,
.summary-table th {
  padding: 8px 12px;
  font-size: 0.9rem;
}

/* ---------------- STICKY LEFT KSHTER COLUMN ---------------- */
.sticky-col-left {
  position: sticky;
  left: 0;
  z-index: 3;
}

/* ---------------- KSHTER CELL (LEFT SIDE HEADER) ---------------- */
.ksheter-cell {
  background: #f3f3f3 !important;
  font-weight: 600;
  color: #3a120f;
  border-right: 2px solid #c8c8c8 !important;
  padding-top: 10px !important;
  padding-bottom: 10px !important;
}

/* ---------------- NORMAL ROW ---------------- */
.ksheter-row td {
  background: #fff !important;
  border-bottom: 1px solid #e5e5e5 !important;
  padding-top: 6px !important;
  padding-bottom: 6px !important;
}

/* Right side slight background difference */
.ksheter-row td:nth-child(2),
.ksheter-row td:nth-child(3) {
  background: #fff !important;
}

/* Hover effect */
.ksheter-row:hover td {
  background: #f7f7f7 !important;
}

/* ==========================================================
   PREMIUM KSHTER BLOCK BOX ‚Äì THE MAIN THICK BORDER EFFECT
   ========================================================== */

/* TOP border of a Ksheter block */
.ksheter-block-start td {
  border-top: 3px solid #7d7d7d !important;
}

/* BOTTOM border of a Ksheter block */
.ksheter-block-end td {
  border-bottom: 3px solid #7d7d7d !important;
}

/* LEFT + RIGHT border across entire block */
.ksheter-block-start td,
.ksheter-block-end td,
.ksheter-row td {
  border-left: 3px solid #7d7d7d !important;
  border-right: 3px solid #7d7d7d !important;
}

/* Gap between Ksheter sections */
.ksheter-block-end {
  margin-bottom: 10px;
}

/* Slight rounded corners on block */
.ksheter-block-start td:first-child {
  border-top-left-radius: 6px;
}
.ksheter-block-start td:last-child {
  border-top-right-radius: 6px;
}
.ksheter-block-end td:first-child {
  border-bottom-left-radius: 6px;
}
.ksheter-block-end td:last-child {
  border-bottom-right-radius: 6px;
}

</style>



<div class="container mt-3">
  <h3 class="text-center mb-4 fw-bold text-danger">
    <img src="/images/logo.jpg" alt="BYS Logo" style="height: 40px; vertical-align: middle; margin-right: 10px;" />
    TOP Attendance Report
  </h3>

  <!-- Filter Form -->
  <form id="reportForm" method="GET" action="/attendance/top10" class="row g-2 mb-4 align-items-end">
    <div class="col-6 col-md-3">
      <label class="form-label">Select Month</label>
      <select name="month" class="form-control" required>
        <option value="">Month</option>
        <% for (let m = 1; m <= 12; m++) { %>
          <option value="<%= m %>" <%= selectedMonth == m ? 'selected' : '' %>>
            <%= new Date(2000, m - 1).toLocaleString('default', { month: 'long' }) %>
          </option>
        <% } %>
      </select>
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Select Year</label>
      <select name="year" class="form-control" required>
        <option value="">Year</option>
        <% for (let y = 2024; y <= 2030; y++) { %>
          <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
        <% } %>
      </select>
    </div>

    <%- include('../partials/scope-dropdowns') %>

    <div class="col-6 col-md-3">
      <label class="form-label">+Prev. Months</label>
      <input type="number" name="prevMonths" min="1" max="12" value="<%= prevMonths %>" class="form-control" required />
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Attendance Upto %</label>
      <input type="number" name="attendPer" min="1" max="100" value="<%= attendPer %>" class="form-control" required />
    </div>

    <div class="col-12 col-md-3">
      <button type="submit" class="btn btn-primary w-100">üîç View Report</button>
    </div>
  </form>

  <!-- Modal -->
  <div class="modal fade" id="selectScopeModal" tabindex="-1" aria-labelledby="selectScopeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title fw-bold" id="selectScopeModalLabel">Please Select Scope</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Please select at least Zila, Ksheter, or Kender to generate the report.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>


  <% if (typeof reportGenerated !== 'undefined' && reportGenerated) { %>
    <% if (attendanceData.length > 0 && !noData) { %>
      <div class="text-end mb-2">
        <button class="btn btn-danger btn-sm" id="exportPdfBtn">üìÑ Export PDF</button>
        <button class="btn btn-success btn-sm" id="exportImageBtn">üñºÔ∏è Export Image</button>
      </div>

      <div class="summary-section mb-4">
  <h5 class="fw-bold mb-3">üìä Ksheter-wise & Kender-wise Summary</h5>

  <div class="table-responsive">
  <table class="table table-sm align-middle summary-table">
    <thead class="text-white" style="background:#3a120f;">
      <tr>
        <th class="sticky-col-left" style="width: 25%;">Ksheter</th>
        <th style="width: 35%;">Kender</th>
        <th style="width: 20%;">Saadhak Count</th>
      </tr>
    </thead>

   <tbody>
<%
  const sortedKsheter = Object.keys(ksheterSummaryMap).sort((a, b) => {
    const isA = (a === 'Adhikari');
    const isB = (b === 'Adhikari');
    if (isA && !isB) return -1;
    if (!isA && isB) return 1;
    return a.localeCompare(b);
  });
%>

<% sortedKsheter.forEach(ksheter => { %>

  <% let kendras = ksheterSummaryMap[ksheter].kendras || {}; %>
  <% let kendersArr = Object.keys(kendras); %>

  <% for (let index = 0; index < kendersArr.length; index++) {
        const kender = kendersArr[index];
        const isFirst = index === 0;
        const isLast  = index === (kendersArr.length - 1);
  %>

    <tr class="ksheter-row
               <%= isFirst ? ' ksheter-block-start' : '' %>
               <%= isLast ? ' ksheter-block-end' : '' %>">

      <% if (isFirst) { %>
        <td rowspan="<%= kendersArr.length %>" class="ksheter-cell sticky-col-left">
          <%= ksheter %>
          <span class="badge text-bg-secondary"><%= ksheterSummaryMap[ksheter].total %></span>
        </td>
      <% } %>

      <td><%= kender %></td>

      <td>
        <span class="badge text-bg-primary"><%= kendras[kender] %></span>
      </td>
    </tr>

  <% } %>
<% }); %>
</tbody>



  </table>
</div>



      <div id="reportSection" class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center shadow-sm">
          <thead class="bg-danger text-white">
            <tr>
              <th>Saadhak</th>
              <th>Ksheter</th>
              <th>Kender</th>
              <th style="width: 60px;">Attd%</th>
            </tr>
          </thead>
          <tbody>
            <% attendanceData.forEach((s) => { %>
              <tr>
                <td class="fw-semibold text-start"><%= s.name %></td>
                <td><%= s.ksheter %></td>
                <td><%= s.kender %></td>
                <td class="fw-bold text-danger" style="white-space: nowrap;">
                  <%= s.presentCount %> / <%= s.totalOperationalDays %> (<%= ((s.presentCount / s.totalOperationalDays) * 100).toFixed(2) %>%)
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-muted text-center mt-4">No data found for selected month.</p>
    <% } %>
  <% } %>

  <%
    function getShortName(kenderName) {
      const words = kenderName.trim().split(/\s+/);
      if (words.length === 1) return kenderName;

      const lastWord = words[words.length - 1];
      const initials = words.slice(0, -1).map(word => word[0].toUpperCase()).join('');
      return initials + ' ' + lastWord;
    }
  %>

  <div id="pdfCloneContainer" style="position: absolute; left: -9999px;"></div>
</div>

<!-- Scripts -->
<!-- Remove or comment out these to avoid conflict with new PDF export -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


<!-- Add jsPDF and jsPDF AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  const reportForm = document.getElementById('reportForm');
  reportForm.addEventListener('submit', function (e) {
    const zila = document.querySelector('[name="zila"]').value.trim();
    const ksheter = document.querySelector('[name="ksheter"]').value.trim();
    const kender = document.querySelector('[name="kender"]').value.trim();
    
    if (zila === "" && ksheter === "" && kender === "") {
      e.preventDefault();
      const modal = new bootstrap.Modal(document.getElementById('selectScopeModal'));
      modal.show();
    }
  });

  // Convert your EJS attendanceData into JS array
  const attendanceData = <%- JSON.stringify(attendanceData) %>;
  const zilaName = "<%= zilaName %>";
  const selectedMonth = <%= selectedMonth %>;
  const selectedYear = <%= selectedYear %>;
  const prevMonths = <%= prevMonths %>;
  const ksheterSummaryMap = <%- JSON.stringify(ksheterSummaryMap) %>;

  // Helper function for short names (same as EJS one)
  function getShortName(kenderName) {
    const words = kenderName.trim().split(/\s+/);
    if (words.length === 1) return kenderName;

    const lastWord = words[words.length - 1];
    const initials = words.slice(0, -1).map(word => word[0].toUpperCase()).join('');
    return initials + ' ' + lastWord;
  }

/* ================= IMAGE HELPER ================= */
async function loadImageAsBase64(url) {
  return new Promise((resolve) => {
    if (!url) return resolve(null);

    const img = new Image();
    img.crossOrigin = "anonymous";

    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL("image/jpeg", 1));
    };

    img.onerror = () => resolve(null);
    img.src = url;
  });
}

/* ================= EXPORT PDF ================= */
document.getElementById('exportPdfBtn')?.addEventListener('click', async function () {
  const loadingSpinner = document.getElementById('loadingSpinner');
  loadingSpinner.style.display = 'block';

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });

  /* ================= HEADER / FOOTER ================= */
  function addHeaderFooter(data) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const marginLeft = 20;
    const marginRight = 20;

    // Header
    doc.setFillColor(180, 30, 45);
    doc.rect(0, 0, pageWidth, 52, 'F');

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(255);
    doc.text("BHARTIYA YOG SANSTHAN (Regd.)", marginLeft, 30);

    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text(String(zilaName || ""), marginLeft, 46);

    const monthYearStr = new Date(2000, selectedMonth - prevMonths).toLocaleString('default', { month: 'short' }) +
      " " + selectedYear + " - " + new Date(2000, selectedMonth - 1).toLocaleString('default', { month: 'short' }) +
      " " + selectedYear;

    const rightText = `TOP Attendance Report - ${monthYearStr}`;
    const rightWidth = doc.getTextWidth(rightText);
    doc.text(rightText, pageWidth - marginRight - rightWidth, 46);

    // Footer
    doc.setFontSize(9);
    doc.setTextColor(0);
    doc.text(
      `Page ${data.pageNumber}`,
      marginLeft,
      pageHeight - 14
    );

    const footerText = "Exported from Bhartiya Yog Sansthan App";
    const footerWidth = doc.getTextWidth(footerText);
    doc.text(
      footerText,
      pageWidth - marginRight - footerWidth,
      pageHeight - 14
    );
  }

    /* ================= ATTENDANCE TABLE ================= */
  const head = [['      ', 'Saadhak', 'Attd%']];
  const body = [];

  for (const s of attendanceData) {
    const photoBase64 = await loadImageAsBase64(s.photoURL);

    body.push([
      '',
      '',
      `${s.presentCount} / ${s.totalOperationalDays} (${(
        (s.presentCount / s.totalOperationalDays) * 100
      ).toFixed(2)}%)`,
    ]);

    body[body.length - 1]._photoBase64 = photoBase64;
    body[body.length - 1]._name = s.name?.toUpperCase();
    body[body.length - 1]._kender = s.kender;
    body[body.length - 1]._ksheter = s.ksheter;
  }

  doc.autoTable({
    head,
    body,
    startY: 80, // üîí fixed safe start
    margin: { top: 70, bottom: 90, left: 20, right: 20 }, // üîí bottom buffer

    styles: {
      fontSize: 24,
      fontStyle: 'bold',
      cellPadding: 2,
      valign: 'middle',
      textColor: [0, 0, 0],
      minCellHeight: 64, // üîí taller than image
      lineWidth: { top: 0.4, bottom: 0.4 },
      lineColor: [0, 0, 0],
    },

    columnStyles: {
  0: { cellWidth: 48 },
  1: { cellWidth: 340, halign: 'left' },  // Fixed width for name column
  2: { cellWidth: 120, fontSize: 16, fontStyle: 'bold', textColor: [180, 30, 45], halign: 'right' },
},

    headStyles: {
      minCellHeight: 16,
      fillColor: [180, 30, 45],
      textColor: [255, 255, 255],
      fontStyle: 'bold',
      fontSize: 9.5,
    },

    didParseCell(data) {
  if (data.section === 'body' && data.column.index === 0) {
    data.cell.text = '';
    data.cell._photoBase64 = body[data.row.index]._photoBase64;
  }
  if (data.section === 'body' && data.column.index === 1) {
    data.cell.text = '';
    data.cell._name = body[data.row.index]._name;
    data.cell._kender = body[data.row.index]._kender;
    data.cell._ksheter = body[data.row.index]._ksheter;
  }
  
},

    didDrawCell(data) {
  // Existing photo drawing code...
  if (data.section === 'body' && data.column.index === 0 && 
    data.cell._photoBase64
  ) {
    const pageHeight = doc.internal.pageSize.getHeight();
    const bottomLimit = pageHeight - 100; // SAME as bottom margin

    // üö´ SAFETY GUARD: do NOT draw if too close to page end
    if (data.cell.y + data.cell.height > bottomLimit) {
      return; // image will be drawn on next page instead
    }

    const maxSize = 56;
    const props = doc.getImageProperties(data.cell._photoBase64);

    let w, h;
    if (props.height > props.width) {
      h = maxSize;
      w = (props.width / props.height) * maxSize;
    } else {
      w = maxSize;
      h = (props.height / props.width) * maxSize;
    }

    const x = data.cell.x + (data.cell.width - w) / 2;
    const y = data.cell.y + (data.cell.height - h) / 2;

    doc.addImage(data.cell._photoBase64, 'JPEG', x, y, w, h);
  }

  if (data.section === 'body' && data.column.index === 1 && data.cell._name) {
    const x = data.cell.x + 4;
    const centerY = data.cell.y + data.cell.height / 2;

    // Draw name in big font
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(20, 15, 255);
    doc.text(data.cell._name || '', x, centerY - 6);

    // Draw kender in small font below
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(255, 65, 30);
    doc.text(data.cell._kender || '', x, centerY + 10);

    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(25, 135, 13);
    doc.text(data.cell._ksheter || '', x, centerY + 10 + 14);
  }
},

    didDrawPage: addHeaderFooter,
    pageBreak: 'auto',
  });

  doc.save(`Top_Attendance_${selectedMonth}_${selectedYear}.pdf`);
  loadingSpinner.style.display = 'none';
});

  // Image export (kept your existing code)
  document.getElementById('exportImageBtn')?.addEventListener('click', function () {
    const cloneContainer = document.getElementById("pdfCloneContainer");
    cloneContainer.innerHTML = "";

    // Clone and style the report table for better image quality
    const tableClone = document.querySelector("#reportSection table").cloneNode(true);
    tableClone.style.borderCollapse = "collapse";
    tableClone.style.width = "100%";
    tableClone.style.tableLayout = "auto";

    tableClone.querySelectorAll("th").forEach((cell) => {
      cell.style.backgroundColor = "#dc3545";
      cell.style.color = "#ffffff";
      cell.style.fontWeight = "bold";
      cell.style.fontSize = "14px";
      cell.style.border = "1px solid #bbb";
      cell.style.padding = "4px 6px";
      cell.style.whiteSpace = "nowrap";
      cell.style.textAlign = "center";
    });

    tableClone.querySelectorAll("td").forEach((cell) => {
      cell.style.color = "#000000";
      cell.style.fontSize = "16px";
      cell.style.padding = "4px 6px";
      cell.style.border = "1px solid #000000";
      cell.style.whiteSpace = "nowrap";
      cell.style.textAlign = "center";
    });

    const wrapper = document.createElement("div");
    wrapper.style.padding = "15px";
    wrapper.style.border = "3px solid #dc3545";
    wrapper.style.backgroundColor = "#ffffff";
    wrapper.style.fontFamily = "'Segoe UI', 'Roboto', sans-serif";
    wrapper.style.maxWidth = "700px";
    wrapper.style.margin = "0 auto";
    wrapper.style.width = "100%";
    wrapper.style.boxShadow = "0 0 6px rgba(0,0,0,0.1)";

    const header = document.createElement("div");
    header.style.textAlign = "center";
    header.style.marginBottom = "12px";

    const logo = document.createElement("img");
    logo.src = "/images/logo.jpg";
    logo.alt = "BYS Logo";
    logo.style.height = "40px";
    logo.style.marginBottom = "6px";

    const title = document.createElement("h2");
    title.style.color = "#dc3545";
    title.style.margin = "2px 0";
    title.style.fontSize = "18px";
    title.textContent = "BHARTIYA YOG SANSTHAN (Regd.)";

    const zilaLine = document.createElement("p");
    zilaLine.style.margin = "0";
    zilaLine.style.fontSize = "12px";
    zilaLine.style.color = "#000000";
    zilaLine.style.fontWeight = "bold";
    zilaLine.textContent = zilaName;

    const subtitle = document.createElement("p");
    subtitle.style.margin = "0";
    subtitle.style.fontSize = "12px";
    subtitle.style.color = "#000000";
    subtitle.textContent = `Top ${topN} Saadhaks ‚Äì ${monthYearStr}`;

    header.appendChild(logo);
    header.appendChild(title);
    header.appendChild(zilaLine);
    header.appendChild(subtitle);

    const footerNote = document.createElement("p");
    footerNote.style.marginTop = "12px";
    footerNote.style.fontSize = "10px";
    footerNote.style.color = "#666";
    footerNote.style.textAlign = "center";
    footerNote.textContent = "Exported from Bhartiya Yog Sansthan App";

    wrapper.appendChild(header);
    wrapper.appendChild(tableClone);
    wrapper.appendChild(footerNote);

    cloneContainer.appendChild(wrapper);

    html2canvas(wrapper, { scale: 4, useCORS: true }).then((canvas) => {
      const link = document.createElement('a');
      link.download = `Top_${topN}_Attendance_${selectedMonth}_${selectedYear}.jpg`;
      link.href = canvas.toDataURL('image/jpeg', 1.0);
      link.click();
    });
  });
</script>

<%- include('../partials/footer') %>
