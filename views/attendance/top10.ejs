<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container mt-3">
  <h3 class="text-center mb-4 fw-bold text-danger">
    <img src="/images/logo.jpg" alt="BYS Logo" style="height: 40px; vertical-align: middle; margin-right: 10px;" />
    Top <%= topN %> Attendance
  </h3>

  <!-- Filter Form -->
  <form method="GET" action="/attendance/top10" class="row g-2 mb-4 align-items-end">
    <div class="col-6 col-md-3">
      <label class="form-label">Select Month</label>
      <select name="month" class="form-control" required>
        <option value="">Month</option>
        <% for (let m = 1; m <= 12; m++) { %>
          <option value="<%= m %>" <%= selectedMonth == m ? 'selected' : '' %>>
            <%= new Date(2000, m - 1).toLocaleString('default', { month: 'long' }) %>
          </option>
        <% } %>
      </select>
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Select Year</label>
      <select name="year" class="form-control" required>
        <option value="">Year</option>
        <% for (let y = 2024; y <= 2030; y++) { %>
          <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
        <% } %>
      </select>
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Scope</label>
      <select name="scope" class="form-control" onchange="this.form.submit()">
        <option value="zila" <%= selectedScope === 'zila' ? 'selected' : '' %>>Zila</option>
        <option value="ksheter" <%= selectedScope === 'ksheter' ? 'selected' : '' %>>Ksheter</option>
        <option value="kender" <%= selectedScope === 'kender' ? 'selected' : '' %>>Kender</option>
      </select>
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Top N (10‚Äì20)</label>
      <input
        type="number"
        name="top"
        min="10"
        max="20"
        value="<%= topN %>"
        class="form-control"
        required
      />
    </div>


    <div class="col-12 col-md-3">
      <button class="btn btn-primary w-100">üîç View Report</button>
    </div>
  </form>

  <% if (attendanceData.length > 0 && !noData) { %>
    <div class="text-end mb-2">
      <button class="btn btn-danger btn-sm" id="exportPdfBtn">üìÑ Export PDF</button>
      <button class="btn btn-success btn-sm" id="exportImageBtn">üñºÔ∏è Export Image</button>
    </div>


    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle text-center shadow-sm">
        <thead class="bg-danger text-white">
          <tr>
            <th>Saadhak</th>
            <th>Ksheter</th>
            <th>Kender</th>
            <th style="width: 60px;">Days</th> 
          </tr>
        </thead>
        <tbody>
          <% attendanceData.forEach((s, index) => { %>
            <tr>
              <td class="fw-semibold text-start"><%= s.name %></td>
              <td><%= s.ksheter %></td>
              <td><%= s.kender %></td>
              <td class="fw-bold text-danger"><%= s.presentCount %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <p class="text-muted text-center mt-4">No data found for selected month.</p>
  <% } %>
</div>

<!-- PDF clone area (hidden) -->
<div id="pdfCloneContainer" style="position: absolute; left: -9999px;"></div>

<!-- Export Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  document.getElementById("exportPdfBtn")?.addEventListener("click", () => {
    const cloneContainer = document.getElementById("pdfCloneContainer");
    cloneContainer.innerHTML = "";

    const clone = document.querySelector("table").cloneNode(true);

    // Table Styling
    clone.style.borderCollapse = "collapse";
    clone.style.width = "100%";
    clone.style.tableLayout = "fixed";
    clone.style.fontSize = "12px";

    clone.querySelectorAll("th").forEach((cell) => {
      cell.style.backgroundColor = "#dc3545";
      cell.style.color = "#fff";
      cell.style.fontWeight = "bold";
      cell.style.fontSize = "13px";
      cell.style.border = "1px solid #bbb";
      cell.style.padding = "8px";
      if (cell.textContent.trim() === "Days") {
        cell.style.width = "60px"; // üëà narrow column
      }
    });

    clone.querySelectorAll("td").forEach((cell) => {
      cell.style.border = "1px solid #bbb";
      cell.style.padding = "6px";
      cell.style.textAlign = "center";
      cell.style.wordWrap = "break-word";
      cell.style.whiteSpace = "normal";
      cell.style.fontSize = "12px";
    });

    // Wrapper Styling
   const wrapper = document.createElement("div");
    wrapper.style.padding = "20px";
    wrapper.style.border = "4px solid #dc3545";  // ‚úÖ Thick solid red border
    wrapper.style.boxSizing = "border-box";      // ‚úÖ Ensure border is included within size
    wrapper.style.backgroundColor = "#fff";
    wrapper.style.fontFamily = "'Segoe UI', 'Roboto', sans-serif";
    wrapper.style.maxWidth = "700px";
    wrapper.style.margin = "0 auto";
    wrapper.style.width = "100%";
    wrapper.style.boxShadow = "0 0 10px rgba(0,0,0,0.15)";
    wrapper.style.webkitFontSmoothing = "antialiased";
    wrapper.style.textRendering = "optimizeLegibility";
    wrapper.style.fontSmoothing = "antialiased";
    wrapper.style.backgroundColor = "#fff";  
    // Header Section
    const header = document.createElement("div");
    header.style.textAlign = "center";
    header.style.marginBottom = "20px";

    const logo = document.createElement("img");
    logo.src = "/images/logo.jpg";
    logo.alt = "BYS Logo";
    logo.style.height = "60px";
    logo.style.marginBottom = "10px";

    const title = document.createElement("h2");
    title.style.color = "#dc3545";
    title.style.margin = "5px 0";
    title.style.fontSize = "18px";
    title.textContent = "BHARTIYA YOG SANSTHAN (Regd.)";

    const zilaLine = document.createElement("p");
    zilaLine.style.margin = "0";
    zilaLine.style.fontSize = "13px";
    zilaLine.style.color = "#444";
    zilaLine.style.fontWeight = "bold";
    zilaLine.textContent = "<%= zilaName %>"; 

    const subtitle = document.createElement("p");
    subtitle.style.margin = "0";
    subtitle.style.fontSize = "13px";
    subtitle.style.color = "#333";
    subtitle.textContent = `Top <%= topN %> Saadhaks ‚Äì <%= new Date(2000, selectedMonth - 1).toLocaleString('default', { month: 'long' }) %> <%= selectedYear %>`;

    header.appendChild(logo);
    header.appendChild(title);
    header.appendChild(zilaLine); 
    header.appendChild(subtitle);

    // Footer Section
    const footerNote = document.createElement("p");
    footerNote.style.marginTop = "20px";
    footerNote.style.fontSize = "11px";
    footerNote.style.color = "#888";
    footerNote.style.textAlign = "center";
    footerNote.textContent = "Exported from Bhartiya Yog Sansthan App";

    wrapper.appendChild(header);
    wrapper.appendChild(clone);
    wrapper.appendChild(footerNote);

    cloneContainer.appendChild(wrapper);

    html2pdf().set({
      margin: [0.4, 0.4, 0.4, 0.4],
      filename: `Top<%= topN %>_Attendance_<%= selectedMonth %>_<%= selectedYear %>.pdf`,
      image: { type: 'jpeg', quality: 1 },      // ‚úÖ Keep JPEG for lighter PDF
      html2canvas: { scale: 4, useCORS: true },    // ‚úÖ Use scale 3 (balanced)
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    }).from(wrapper).save();
  });

  document.getElementById("exportImageBtn")?.addEventListener("click", () => {
    const cloneContainer = document.getElementById("pdfCloneContainer");
    cloneContainer.innerHTML = "";

    const clone = document.querySelector("table").cloneNode(true);

    clone.style.borderCollapse = "collapse";
    clone.style.width = "100%";
    clone.style.tableLayout = "fixed";
    clone.style.fontSize = "12px";

    clone.querySelectorAll("th").forEach((cell) => {
      cell.style.backgroundColor = "#dc3545";
      cell.style.color = "#fff";
      cell.style.fontWeight = "bold";
      cell.style.fontSize = "13px";
      cell.style.border = "1px solid #bbb";
      cell.style.padding = "8px";
      if (cell.textContent.trim() === "Days") {
        cell.style.width = "60px";
      }
    });

    clone.querySelectorAll("td").forEach((cell) => {
      cell.style.border = "1px solid #bbb";
      cell.style.padding = "6px";
      cell.style.textAlign = "center";
      cell.style.wordWrap = "break-word";
      cell.style.whiteSpace = "normal";
      cell.style.fontSize = "12px";
    });

    const wrapper = document.createElement("div");
    wrapper.style.padding = "20px";
    wrapper.style.border = "4px solid #dc3545";
    wrapper.style.boxSizing = "border-box";
    wrapper.style.backgroundColor = "#fff";
    wrapper.style.fontFamily = "'Segoe UI', 'Roboto', sans-serif";
    wrapper.style.maxWidth = "700px";
    wrapper.style.margin = "0 auto";
    wrapper.style.width = "100%";
    wrapper.style.boxShadow = "0 0 10px rgba(0,0,0,0.15)";
    wrapper.style.webkitFontSmoothing = "antialiased";
    wrapper.style.textRendering = "optimizeLegibility";

    const header = document.createElement("div");
    header.style.textAlign = "center";
    header.style.marginBottom = "20px";

    const logo = document.createElement("img");
    logo.src = "/images/logo.jpg";
    logo.alt = "BYS Logo";
    logo.style.height = "60px";
    logo.style.marginBottom = "10px";

    const title = document.createElement("h2");
    title.style.color = "#dc3545";
    title.style.margin = "5px 0";
    title.style.fontSize = "18px";
    title.textContent = "BHARTIYA YOG SANSTHAN (Regd.)";

    const zilaLine = document.createElement("p");
    zilaLine.style.margin = "0";
    zilaLine.style.fontSize = "13px";
    zilaLine.style.color = "#444";
    zilaLine.style.fontWeight = "bold";
    zilaLine.textContent = "<%= zilaName %>";

    const subtitle = document.createElement("p");
    subtitle.style.margin = "0";
    subtitle.style.fontSize = "13px";
    subtitle.style.color = "#333";
    subtitle.textContent = `Top <%= topN %> Saadhaks ‚Äì <%= new Date(2000, selectedMonth - 1).toLocaleString('default', { month: 'long' }) %> <%= selectedYear %>`;

    header.appendChild(logo);
    header.appendChild(title);
    header.appendChild(zilaLine);
    header.appendChild(subtitle);

    const footerNote = document.createElement("p");
    footerNote.style.marginTop = "20px";
    footerNote.style.fontSize = "11px";
    footerNote.style.color = "#888";
    footerNote.style.textAlign = "center";
    footerNote.textContent = "Exported from Bhartiya Yog Sansthan App";

    wrapper.appendChild(header);
    wrapper.appendChild(clone);
    wrapper.appendChild(footerNote);

    cloneContainer.appendChild(wrapper);

    html2canvas(wrapper, { scale: 4, useCORS: true }).then((canvas) => {
      const link = document.createElement('a');
      link.download = `Top<%= topN %>_Attendance_<%= selectedMonth %>_<%= selectedYear %>.jpg`;
      link.href = canvas.toDataURL('image/jpeg', 1.0);
      link.click();
    });
  });
</script>


<%- include('../partials/footer') %>
